---
phase: 14-social-features
plan: 02
type: execute
wave: 2
depends_on: [14-01]
files_modified:
  - frontend/src/hooks/useNotifications.ts
  - frontend/src/components/workflow/CommentThread.tsx
  - frontend/src/components/ui/NotificationCenter.tsx
  - frontend/src/pages/WorkflowDetailPage.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/common.json
autonomous: true
requirements: [COMM-01, COMM-02, COMM-03, COMM-04, COMM-05, NOTIF-01, NOTIF-02, NOTIF-03, NOTIF-04, NOTIF-06, NOTIF-07]

must_haves:
  truths:
    - "User sees a comment thread below the workflow stepper on the detail page"
    - "User can type and submit a plain-text comment that appears chronologically"
    - "Comment input is visibly disabled on terminal-state workflows (APPROVED, REFUSED, CANCELLED, ARCHIVED)"
    - "Bell icon in navigation shows unread notification count badge"
    - "Unread count updates every 30 seconds without page reload"
    - "Clicking bell opens a slide-out panel listing recent notifications with workflow links"
    - "User can mark individual notifications or all as read"
    - "User can toggle per-type notification preferences from the profile page"
    - "Comments cannot be edited or deleted (no edit/delete UI exists)"
  artifacts:
    - path: "frontend/src/hooks/useNotifications.ts"
      provides: "Notification polling hook with 30s refetchInterval"
      exports: ["useNotifications", "useUnreadCount"]
    - path: "frontend/src/components/workflow/CommentThread.tsx"
      provides: "Comment thread UI component"
      exports: ["CommentThread"]
    - path: "frontend/src/components/ui/NotificationCenter.tsx"
      provides: "Slide-out notification panel"
      exports: ["NotificationCenter"]
    - path: "frontend/src/pages/WorkflowDetailPage.tsx"
      provides: "Updated detail page with CommentThread integration"
      contains: "CommentThread"
    - path: "frontend/src/pages/DashboardPage.tsx"
      provides: "Updated dashboard with NotificationCenter bell icon"
      contains: "NotificationCenter"
  key_links:
    - from: "frontend/src/hooks/useNotifications.ts"
      to: "/api/notifications"
      via: "apiFetch with TanStack Query refetchInterval: 30000"
      pattern: "refetchInterval.*30"
    - from: "frontend/src/components/workflow/CommentThread.tsx"
      to: "/api/workflows/:id/comments"
      via: "apiFetch GET and POST"
      pattern: "apiFetch.*comments"
    - from: "frontend/src/components/ui/NotificationCenter.tsx"
      to: "frontend/src/hooks/useNotifications.ts"
      via: "hook consumption for list and mutations"
      pattern: "useNotifications"
    - from: "frontend/src/pages/WorkflowDetailPage.tsx"
      to: "frontend/src/components/workflow/CommentThread.tsx"
      via: "component import and render below stepper"
      pattern: "CommentThread"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/components/ui/NotificationCenter.tsx"
      via: "component import, bell icon triggers panel open"
      pattern: "NotificationCenter"
---

<objective>
Build all frontend components for workflow comments and in-app notifications: the CommentThread component on WorkflowDetailPage, the NotificationCenter slide-out panel with bell icon, notification polling hook, and notification preferences on the profile page.

Purpose: Delivers the user-facing experience for all COMM and NOTIF requirements. Users can discuss workflows, see notification badges, and manage preferences.
Output: 3 new files + 4 modified files. Complete frontend for comments and notifications.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-social-features/14-01-SUMMARY.md
@frontend/src/pages/WorkflowDetailPage.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/src/hooks/useAuth.ts
@frontend/src/lib/api.ts
@frontend/src/i18n/locales/en/common.json
@frontend/src/i18n/locales/fr/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useNotifications hook and CommentThread component</name>
  <files>frontend/src/hooks/useNotifications.ts, frontend/src/components/workflow/CommentThread.tsx</files>
  <action>
**useNotifications.ts:**

Create a custom hook file that exports two hooks:

1. `useNotifications()` — Returns notifications list + mutations:
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiFetch } from '../lib/api';

interface Notification {
  id: string;
  type: string;
  context: { workflowId?: string; workflowTitle?: string; stepName?: string; actorEmail?: string; commentAuthor?: string };
  read: boolean;
  createdAt: string;
}

interface NotificationsResponse {
  notifications: Notification[];
  unreadCount: number;
}
```

- useQuery with queryKey ['notifications'], fetches `GET /notifications?limit=30`, refetchInterval: 30000 (30s polling per NOTIF-06).
- `markRead` mutation: PATCH `/notifications/${id}/read`, invalidates ['notifications'] on success.
- `markAllRead` mutation: PATCH `/notifications/read-all` with body '{}', invalidates ['notifications'] on success.
- Return: `{ notifications, unreadCount, isLoading, markRead, markAllRead }`.

2. `useUnreadCount()` — Lightweight hook returning just the count (for the bell badge). Uses the same query key so it shares cache with useNotifications:
```typescript
export function useUnreadCount() {
  const { data } = useQuery<NotificationsResponse>({
    queryKey: ['notifications'],
    queryFn: () => apiFetch<NotificationsResponse>('/notifications?limit=30'),
    refetchInterval: 30000,
  });
  return data?.unreadCount ?? 0;
}
```

3. `useNotificationPrefs()` — Returns prefs + update mutation:
- useQuery with queryKey ['notification-prefs'], fetches `GET /users/me/notification-prefs`.
- `updatePrefs` mutation: PUT `/users/me/notification-prefs` with body, invalidates ['notification-prefs'].
- Return: `{ prefs, isLoading, updatePrefs }`.

**CommentThread.tsx:**

Create a component that takes `workflowId: string` and `workflowStatus: string` as props.

Structure:
```typescript
interface Comment {
  id: string;
  body: string;
  createdAt: string;
  author: { id: string; name: string; email: string };
}
```

1. Use `useQuery` to fetch `GET /workflows/${workflowId}/comments` with queryKey `['comments', workflowId]`.
2. Display comments in chronological order (oldest first). Each comment shows: author name, relative time (or formatted date), and the body text. Use a simple card layout with left border accent.
3. Below the list, show a textarea + submit button for new comments.
4. If workflowStatus is in terminal states (APPROVED, REFUSED, CANCELLED, ARCHIVED), the textarea is disabled and shows a message like "Comments are closed on completed workflows". This implements COMM-04.
5. Use `useMutation` for POST `/workflows/${workflowId}/comments` with body `{ body: commentText }`. On success, invalidate the comments query and clear the textarea.
6. There is NO edit or delete UI for comments (COMM-03 — append only).
7. If the GET returns 403 (non-participant), show a message "You do not have access to comments on this workflow" instead of the thread.
8. Use i18n for all visible strings (t('comments.title'), t('comments.placeholder'), t('comments.submit'), t('comments.closed'), t('comments.no_access'), t('comments.empty')).

Styling: Match the existing WorkflowDetailPage aesthetic — rounded-lg bg-white shadow sections, Tailwind classes consistent with existing components.
  </action>
  <verify>
`cd frontend && npx tsc --noEmit` — no TypeScript errors.
Visually: Open a workflow detail page in the browser. The comment thread section should appear below the stepper (verification in Task 2 when integrated, but the component itself should compile).
  </verify>
  <done>
useNotifications.ts exports useNotifications (with 30s polling), useUnreadCount, and useNotificationPrefs hooks. CommentThread.tsx renders a chronological comment list with add-comment form, disabled input on terminal workflows, and 403 handling for non-participants.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationCenter panel and integrate into DashboardPage + WorkflowDetailPage</name>
  <files>frontend/src/components/ui/NotificationCenter.tsx, frontend/src/pages/DashboardPage.tsx, frontend/src/pages/WorkflowDetailPage.tsx</files>
  <action>
**NotificationCenter.tsx:**

Create a slide-out panel component (NOT a separate page route — per research anti-pattern).

Props: `open: boolean`, `onClose: () => void`.

Structure:
1. Render as a fixed overlay: a semi-transparent backdrop + a right-side panel that slides in (translate-x transition). Width: max-w-sm or w-80.
2. Header: "Notifications" title + "Mark all read" button (calls markAllRead mutation from useNotifications).
3. List: Map over notifications from useNotifications(). Each item shows:
   - Notification type icon/label based on type (STEP_APPROVED = green check, STEP_REFUSED = red X, WORKFLOW_COMPLETED = green badge, WORKFLOW_REFUSED = red badge, COMMENT_ADDED = chat bubble)
   - Description text derived from context: e.g., "Step {stepName} was approved on {workflowTitle}" or "New comment on {workflowTitle} by {commentAuthor}"
   - Relative timestamp (use simple "X min ago" / "X hours ago" / date format — no external library needed, compute from createdAt)
   - Unread indicator: blue dot for unread notifications
   - Click handler: marks as read (markRead mutation) + navigates to `/workflows/${context.workflowId}` via useNavigate
4. If no notifications, show empty state text.
5. Close button (X icon) in the header.
6. Use i18n for all text.

**DashboardPage.tsx modifications:**

1. Import `NotificationCenter` and `useUnreadCount` at the top.
2. Add state: `const [notifOpen, setNotifOpen] = useState(false);`
3. Replace the existing bell icon button in the header (around line 210-223). Currently it calls `handleTabChange('pending')`. Change it to:
   - Use `useUnreadCount()` for the badge count instead of `pendingCount`.
   - onClick: `setNotifOpen(true)` instead of `handleTabChange('pending')`.
   - Keep the same SVG bell icon.
   - The badge now shows notification unread count (not pending validation count).
4. Keep the existing "pending" tab and its badge showing pendingCount — that's a separate concept (pending validations vs notifications).
5. Render `<NotificationCenter open={notifOpen} onClose={() => setNotifOpen(false)} />` at the end of the component, before the closing div.

**WorkflowDetailPage.tsx modifications:**

1. Import `CommentThread` at the top.
2. Add the CommentThread component below the existing sections (after the "Initiator actions" section and before the "Audit trail" section). Insert:
```tsx
{/* Comment Thread */}
<section>
  <CommentThread workflowId={workflow.id} workflowStatus={workflow.status} />
</section>
```
3. Also add the notification bell icon to the WorkflowDetailPage header. Since this page has its own header (not shared), add a small bell icon with unread count badge next to the back link. Import `useUnreadCount` and `NotificationCenter`, add the same pattern as DashboardPage (state for open, bell button, render NotificationCenter).

This ensures the bell icon with unread badge appears on both major authenticated pages, satisfying NOTIF-01.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` — no TypeScript errors.
2. Start the dev server: `cd frontend && npm run dev`.
3. Open http://localhost:5173/dashboard — bell icon in header shows unread count badge. Clicking it opens the notification center panel.
4. Navigate to a workflow detail page — comment thread section visible below the stepper. If the user is a participant, they can type and submit a comment.
5. On a terminal-state workflow, the comment input is visibly disabled.
  </verify>
  <done>
NotificationCenter slide-out panel renders with notification list, mark-read actions, and workflow links. Bell icon on DashboardPage and WorkflowDetailPage shows unread count from 30s polling. CommentThread integrated into WorkflowDetailPage below the stepper with disabled input on terminal workflows.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add notification preferences to profile page and i18n translations</name>
  <files>frontend/src/i18n/locales/en/common.json, frontend/src/i18n/locales/fr/common.json</files>
  <action>
**Notification preferences UI on ProfilePage:**

Note: Phase 13 creates the ProfilePage with tabs. If ProfilePage does not yet exist when this plan executes (because Phase 13 hasn't run yet), create a minimal placeholder at `frontend/src/pages/ProfilePage.tsx` with a "Notification Preferences" section, and add the route in App.tsx at `/profile`. If ProfilePage already exists, add a new tab or section.

The notification preferences UI should:
1. Import `useNotificationPrefs` from the hooks.
2. Display a list of 5 notification types with toggle switches (checkboxes or toggle buttons):
   - STEP_APPROVED — "Step approved"
   - STEP_REFUSED — "Step refused"
   - WORKFLOW_COMPLETED — "Workflow completed"
   - WORKFLOW_REFUSED — "Workflow refused"
   - COMMENT_ADDED — "New comment"
3. Each toggle reflects the current preference value (true/false). Default all true.
4. When a toggle changes, call `updatePrefs` mutation with the full prefs object.
5. Show a brief success indicator after saving.

**i18n translations:**

Add the following keys to both en/common.json and fr/common.json:

English keys to add:
```json
{
  "comments": {
    "title": "Comments",
    "placeholder": "Write a comment...",
    "submit": "Post",
    "closed": "Comments are closed on completed workflows",
    "no_access": "You do not have access to comments on this workflow",
    "empty": "No comments yet"
  },
  "notifications": {
    "title": "Notifications",
    "mark_all_read": "Mark all read",
    "empty": "No notifications",
    "step_approved": "Step {{stepName}} approved on {{workflowTitle}}",
    "step_refused": "Step {{stepName}} refused on {{workflowTitle}}",
    "workflow_completed": "Workflow {{workflowTitle}} has been approved",
    "workflow_refused": "Workflow {{workflowTitle}} has been refused",
    "comment_added": "New comment on {{workflowTitle}}",
    "just_now": "Just now",
    "minutes_ago": "{{count}} min ago",
    "hours_ago": "{{count}}h ago",
    "days_ago": "{{count}}d ago"
  },
  "notification_prefs": {
    "title": "Notification Preferences",
    "description": "Choose which notifications you want to receive",
    "step_approved": "Step approved",
    "step_refused": "Step refused",
    "workflow_completed": "Workflow completed",
    "workflow_refused": "Workflow refused",
    "comment_added": "New comment",
    "saved": "Preferences saved"
  }
}
```

French keys to add (same structure, translated):
```json
{
  "comments": {
    "title": "Commentaires",
    "placeholder": "Ecrire un commentaire...",
    "submit": "Publier",
    "closed": "Les commentaires sont fermes sur les workflows termines",
    "no_access": "Vous n'avez pas acces aux commentaires de ce workflow",
    "empty": "Aucun commentaire"
  },
  "notifications": {
    "title": "Notifications",
    "mark_all_read": "Tout marquer comme lu",
    "empty": "Aucune notification",
    "step_approved": "Etape {{stepName}} approuvee sur {{workflowTitle}}",
    "step_refused": "Etape {{stepName}} refusee sur {{workflowTitle}}",
    "workflow_completed": "Le workflow {{workflowTitle}} a ete approuve",
    "workflow_refused": "Le workflow {{workflowTitle}} a ete refuse",
    "comment_added": "Nouveau commentaire sur {{workflowTitle}}",
    "just_now": "A l'instant",
    "minutes_ago": "Il y a {{count}} min",
    "hours_ago": "Il y a {{count}}h",
    "days_ago": "Il y a {{count}}j"
  },
  "notification_prefs": {
    "title": "Preferences de notification",
    "description": "Choisissez les notifications que vous souhaitez recevoir",
    "step_approved": "Etape approuvee",
    "step_refused": "Etape refusee",
    "workflow_completed": "Workflow termine",
    "workflow_refused": "Workflow refuse",
    "comment_added": "Nouveau commentaire",
    "saved": "Preferences enregistrees"
  }
}
```

Merge these into the existing JSON structure — do NOT overwrite existing keys. Add them as new top-level sections within the existing JSON object.
  </action>
  <verify>
1. `cd frontend && npx tsc --noEmit` — no TypeScript errors.
2. Check i18n files are valid JSON: `node -e "JSON.parse(require('fs').readFileSync('frontend/src/i18n/locales/en/common.json'))"` — no parse errors.
3. Open the profile page (or wherever notification prefs are placed) — toggles render with correct labels in both EN and FR.
4. Toggle a preference off, refresh the page — the preference persists (saved to backend).
  </verify>
  <done>
Notification preferences UI renders with 5 toggle switches for each notification type. Toggling persists via PUT /users/me/notification-prefs. All new UI strings (comments, notifications, notification prefs) have English and French translations. No missing i18n keys in the UI.
  </done>
</task>

</tasks>

<verification>
1. Frontend compiles: `cd frontend && npx tsc --noEmit` exits 0
2. Dev server starts: `cd frontend && npm run dev` — no console errors
3. Workflow detail page shows comment thread below stepper
4. Comments can be posted and appear chronologically
5. Comment input disabled on terminal-state workflows
6. Bell icon in DashboardPage header shows unread badge updating every 30s
7. Clicking bell opens notification center panel with notification list
8. Notifications link to correct workflow pages
9. Mark read (individual + all) works
10. Notification preferences toggles persist
11. All text displays in both EN and FR
</verification>

<success_criteria>
- CommentThread component renders below stepper on WorkflowDetailPage
- Comments are chronological, append-only (no edit/delete UI)
- Comment input is disabled with message on terminal-state workflows
- Bell icon badge shows unread notification count on DashboardPage and WorkflowDetailPage
- Unread count polls every 30 seconds via TanStack Query refetchInterval
- NotificationCenter slide-out panel opens on bell click
- Each notification shows type, description, timestamp, and links to workflow
- Mark read (individual) and mark all read work
- Notification preferences tab shows 5 toggles that persist to backend
- EN and FR translations cover all new strings
</success_criteria>

<output>
After completion, create `.planning/phases/14-social-features/14-02-SUMMARY.md`
</output>
