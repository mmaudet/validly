---
phase: 16-gap-closure
plan: "01"
gap_closure: true
requirements: [COMM-01, COMM-02, ERR-06, RESP-06, NOTIF-05]
---

# Plan 16-01: Gap Closure â€” All Fixes

## Goal
Fix all 4 defects found during v1.1 milestone audit in a single plan.

## Tasks

### Task 1: Fix CommentThread response parsing (COMM-01, COMM-02)

**Problem:** Backend `GET /api/workflows/:id/comments` returns `Comment[]` array. Frontend `CommentThread.tsx` wraps it in `CommentsResponse { comments: Comment[] }` and reads `data?.comments` which is `undefined` on an array.

**Fix:** Change `CommentThread.tsx`:
- Remove `CommentsResponse` interface
- Change `useQuery<CommentsResponse>` to `useQuery<Comment[]>`
- Change `data?.comments ?? []` to `data ?? []`

**Files:** `frontend/src/components/workflow/CommentThread.tsx`

### Task 2: Wire mapApiError into apiFetch (ERR-06)

**Problem:** `mapApiError` exists in `api.ts` but is never called. API errors display as raw English strings.

**Fix:** In `apiFetch`, use `mapApiError` when throwing the ApiError so ALL consumers get mapped messages automatically:
```ts
throw new ApiError(res.status, mapApiError(body.message ?? res.statusText));
```

**Files:** `frontend/src/lib/api.ts`

### Task 3: Add MobileNav to sub-pages (RESP-06)

**Problem:** MobileNav hamburger only on DashboardPage and AdminUsersPage. Missing from WorkflowDetailPage, TemplateFormPage, ProfilePage.

**Fix:** Add MobileNav to each page's header with the same pattern as DashboardPage. Use pendingCount=0 for sub-pages (badge not critical on sub-pages). Add useAuth/useNavigate/i18n as needed per page.

**Files:**
- `frontend/src/pages/WorkflowDetailPage.tsx`
- `frontend/src/pages/TemplateFormPage.tsx`
- `frontend/src/pages/ProfilePage.tsx`

### Task 4: Fix notification context key (NOTIF-05)

**Problem:** `comment-service.ts` stores `authorEmail: author.email` but `NotificationCenter.tsx` reads `metadata.commentAuthor`.

**Fix:** Change `authorEmail: author.email` to `commentAuthor: author.name` in `comment-service.ts` notification context.

**Files:** `backend/src/services/comment-service.ts`

## Wave Structure

All tasks are independent (different files). Execute all in Wave 1.
