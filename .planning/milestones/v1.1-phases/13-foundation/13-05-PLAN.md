---
phase: 13-foundation
plan: 05
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - frontend/src/pages/NotFoundPage.tsx
  - frontend/src/pages/ErrorPage.tsx
  - frontend/src/components/ErrorBoundary.tsx
  - frontend/src/App.tsx
  - frontend/src/lib/api.ts
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/common.json
autonomous: true
requirements:
  - ERR-01
  - ERR-02
  - ERR-03
  - ERR-06

must_haves:
  truths:
    - "Navigating to a non-existent route shows a 404 page with a link to dashboard"
    - "Server errors show a 500 error page with recovery guidance"
    - "React Router errors are caught by an error boundary and display the error page"
    - "API error responses are mapped to user-readable messages"
  artifacts:
    - path: "frontend/src/pages/NotFoundPage.tsx"
      provides: "404 Not Found page with dashboard link"
      contains: "NotFoundPage"
    - path: "frontend/src/pages/ErrorPage.tsx"
      provides: "500 Server Error page with recovery guidance"
      contains: "ErrorPage"
    - path: "frontend/src/components/ErrorBoundary.tsx"
      provides: "Error boundary wrapper component"
      contains: "ErrorBoundary"
  key_links:
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/NotFoundPage.tsx"
      via: "catch-all route path='*'"
      pattern: 'path="\\*"'
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ErrorBoundary.tsx"
      via: "wrapper around Routes"
      pattern: "ErrorBoundary"
---

<objective>
Implement error handling infrastructure: a dedicated 404 Not Found page, a 500 Server Error page, a React error boundary that catches unhandled errors, and API error message mapping to user-readable text.

Purpose: Users currently see nothing useful when they hit a non-existent route or when an unhandled error occurs. These pages provide clear guidance for recovery and prevent the app from showing a blank white screen on errors.
Output: NotFoundPage, ErrorPage, ErrorBoundary wrapper, and improved API error messages.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/App.tsx
@frontend/src/pages/ActionErrorPage.tsx
@frontend/src/lib/api.ts
@.planning/phases/13-foundation/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotFoundPage and ErrorPage</name>
  <files>frontend/src/pages/NotFoundPage.tsx, frontend/src/pages/ErrorPage.tsx, frontend/src/i18n/locales/en/common.json, frontend/src/i18n/locales/fr/common.json</files>
  <action>
**Create NotFoundPage.tsx (ERR-01):**

Follow the ActionErrorPage.tsx visual pattern (centered card on gray background):
- Large "404" text or a clear icon
- Heading: "Page not found" (i18n: `errors.not_found_title`)
- Body: "The page you're looking for doesn't exist or has been moved." (i18n: `errors.not_found_message`)
- Primary CTA button linking to `/dashboard`: "Go to Dashboard" (i18n: `errors.go_to_dashboard`)
- Secondary link to go back: `window.history.back()` or just the dashboard link is sufficient
- Match existing page styling (bg-gray-50, max-w-md, rounded-lg, shadow)

**Create ErrorPage.tsx (ERR-02):**

Similar layout to NotFoundPage but for 500-type errors:
- Large "500" text or error icon
- Heading: "Something went wrong" (i18n: `errors.server_error_title`)
- Body: "An unexpected error occurred. Please try again or return to the dashboard." (i18n: `errors.server_error_message`)
- Recovery guidance options:
  1. "Try again" button that calls `window.location.reload()`
  2. "Go to Dashboard" link to `/dashboard`
- Accept optional `error` prop for displaying error details in development mode only (`import.meta.env.DEV`)

**Update i18n locale files:**

Add to EN `common.json` `errors` section (merge with existing `errors.not_found`):
```json
"not_found_title": "Page not found",
"not_found_message": "The page you're looking for doesn't exist or has been moved.",
"go_to_dashboard": "Go to Dashboard",
"server_error_title": "Something went wrong",
"server_error_message": "An unexpected error occurred. Please try again or return to the dashboard.",
"try_again": "Try again",
"generic_error": "An error occurred. Please try again."
```

Add equivalent French to FR `common.json` `errors` section:
```json
"not_found_title": "Page non trouvee",
"not_found_message": "La page que vous cherchez n'existe pas ou a ete deplacee.",
"go_to_dashboard": "Aller au tableau de bord",
"server_error_title": "Une erreur est survenue",
"server_error_message": "Une erreur inattendue s'est produite. Veuillez reessayer ou retourner au tableau de bord.",
"try_again": "Reessayer",
"generic_error": "Une erreur est survenue. Veuillez reessayer."
```
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/frontend && npx tsc --noEmit` -- TypeScript compiles
2. NotFoundPage.tsx and ErrorPage.tsx exist with proper exports
3. Grep locale files for `not_found_title` and `server_error_title`
  </verify>
  <done>NotFoundPage shows 404 with dashboard link. ErrorPage shows 500 with retry button and dashboard link. Both pages translated EN/FR.</done>
</task>

<task type="auto">
  <name>Task 2: Error boundary, catch-all route, and API error mapping</name>
  <files>frontend/src/components/ErrorBoundary.tsx, frontend/src/App.tsx, frontend/src/lib/api.ts</files>
  <action>
**Create ErrorBoundary.tsx (ERR-03):**

Use the `react-error-boundary` package (already installed in Plan 01):

```typescript
import { ErrorBoundary as ReactErrorBoundary } from 'react-error-boundary';
import { ErrorPage } from '../pages/ErrorPage';

function ErrorFallback({ error, resetErrorBoundary }: { error: Error; resetErrorBoundary: () => void }) {
  return <ErrorPage error={error} onReset={resetErrorBoundary} />;
}

export function AppErrorBoundary({ children }: { children: React.ReactNode }) {
  return (
    <ReactErrorBoundary
      FallbackComponent={ErrorFallback}
      onReset={() => {
        // Reset app state if needed -- navigate to dashboard
        window.location.href = '/dashboard';
      }}
    >
      {children}
    </ReactErrorBoundary>
  );
}
```

Update ErrorPage to accept an optional `onReset` prop. When provided, the "Try again" button calls `onReset()` instead of `window.location.reload()`.

**Update App.tsx:**

1. Import `AppErrorBoundary` from `../components/ErrorBoundary`.
2. Import `NotFoundPage`.
3. Wrap the `<Routes>` block inside `<AppErrorBoundary>`:
```tsx
<AppErrorBoundary>
  <Routes>
    ...existing routes...
    <Route path="*" element={<NotFoundPage />} />
  </Routes>
</AppErrorBoundary>
```

4. Add the catch-all route `<Route path="*" element={<NotFoundPage />} />` as the LAST route inside `<Routes>`. This catches any unmatched URL and shows the 404 page.

**API error message mapping (ERR-06):**

In `frontend/src/lib/api.ts`, create an `mapApiError` helper function that maps known API error messages to user-friendly i18n keys. Add it above the `apiFetch` function:

```typescript
const API_ERROR_MAP: Record<string, string> = {
  'Invalid credentials': 'auth.invalid_credentials',
  'Email already registered': 'auth.email_taken',
  'Token expired': 'auth.token_expired',
  'Current password is incorrect': 'profile.password_wrong',
  'Invalid or expired reset link.': 'auth.reset_expired',
  'Unauthorized': 'errors.unauthorized',
};

export function mapApiError(message: string): string {
  return API_ERROR_MAP[message] || message;
}
```

Export this function so components can use it: `const errorKey = mapApiError(error.message); const displayMessage = t(errorKey) || error.message;`

This is a utility -- components opt in to using it. The function returns the original message if no mapping exists, so it's safe to use everywhere.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/frontend && npm run build` -- build succeeds
2. Grep App.tsx for `AppErrorBoundary` -- confirms error boundary wrapping
3. Grep App.tsx for `path="*"` -- confirms catch-all route
4. Grep api.ts for `mapApiError` -- confirms error mapping function
5. Grep ErrorBoundary.tsx for `react-error-boundary` -- confirms package usage
  </verify>
  <done>Error boundary catches unhandled React errors and shows ErrorPage. Catch-all route shows NotFoundPage for unknown URLs. API error messages mapped to user-readable i18n keys via mapApiError utility.</done>
</task>

</tasks>

<verification>
1. Frontend builds: `cd /Users/mmaudet/work/validly/frontend && npm run build`
2. Navigating to `/nonexistent-path` would show NotFoundPage (catch-all route exists in App.tsx)
3. Error boundary wraps Routes in App.tsx
4. API error mapping function exported from api.ts
5. Both error pages have EN/FR translations
</verification>

<success_criteria>
- NotFoundPage at catch-all route path="*" shows 404 with dashboard link
- ErrorPage shows 500 with retry button and dashboard link
- AppErrorBoundary catches unhandled React errors
- mapApiError maps known API errors to i18n keys
- All error text translated EN/FR
- Frontend build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-05-SUMMARY.md`
</output>
