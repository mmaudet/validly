---
phase: 13-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - backend/src/services/password-reset-service.ts
  - backend/src/api/routes/auth.ts
  - backend/src/services/email-service.ts
  - frontend/src/pages/ForgotPasswordPage.tsx
  - frontend/src/pages/ResetPasswordPage.tsx
  - frontend/src/App.tsx
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/common.json
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
  - AUTH-03
  - AUTH-04
  - AUTH-05

must_haves:
  truths:
    - "User can enter email on forgot password page and receives a success message regardless of email existence"
    - "Password reset email is sent with a single-use token link when email exists"
    - "User can set a new password via the reset link and all existing sessions are invalidated"
    - "Token consumption is atomic -- concurrent requests cannot both succeed"
    - "Same API response is returned whether email exists or not (no user enumeration)"
  artifacts:
    - path: "backend/src/services/password-reset-service.ts"
      provides: "Password reset token creation and atomic consumption"
      contains: "updateMany"
    - path: "backend/src/api/routes/auth.ts"
      provides: "POST /auth/forgot-password and POST /auth/reset-password routes"
      contains: "forgot-password"
    - path: "backend/src/services/email-service.ts"
      provides: "Password reset email template"
      contains: "sendPasswordReset"
    - path: "frontend/src/pages/ForgotPasswordPage.tsx"
      provides: "Forgot password form page"
      contains: "ForgotPasswordPage"
    - path: "frontend/src/pages/ResetPasswordPage.tsx"
      provides: "Reset password form page"
      contains: "ResetPasswordPage"
  key_links:
    - from: "frontend/src/pages/ForgotPasswordPage.tsx"
      to: "/api/auth/forgot-password"
      via: "apiFetch POST"
      pattern: "apiFetch.*forgot-password"
    - from: "frontend/src/pages/ResetPasswordPage.tsx"
      to: "/api/auth/reset-password"
      via: "apiFetch POST"
      pattern: "apiFetch.*reset-password"
    - from: "backend/src/api/routes/auth.ts"
      to: "backend/src/services/password-reset-service.ts"
      via: "service method call"
      pattern: "passwordResetService"
    - from: "backend/src/services/password-reset-service.ts"
      to: "prisma.passwordResetToken"
      via: "Prisma updateMany WHERE usedAt IS NULL"
      pattern: "updateMany.*usedAt.*null"
---

<objective>
Implement the full password reset flow: backend service with TOCTOU-safe token consumption, Fastify routes, email template, and two frontend pages (forgot password + reset password).

Purpose: Users who forget their password need a secure self-service reset flow. This is a core auth feature that must prevent user enumeration and race conditions.
Output: Working end-to-end password reset: request email -> receive link -> set new password -> all sessions invalidated.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/src/services/token-service.ts
@backend/src/services/auth-service.ts
@backend/src/services/email-service.ts
@backend/src/api/routes/auth.ts
@backend/src/config/env.ts
@frontend/src/lib/api.ts
@frontend/src/pages/LoginPage.tsx
@frontend/src/App.tsx
@.planning/phases/13-foundation/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Password reset backend service, routes, and email template</name>
  <files>backend/src/services/password-reset-service.ts, backend/src/api/routes/auth.ts, backend/src/services/email-service.ts</files>
  <action>
**Create password-reset-service.ts:**

Create `backend/src/services/password-reset-service.ts` with two main functions:

1. `requestPasswordReset(email: string)`:
   - Look up user by email. If not found, return silently (no error -- AUTH-04 anti-enumeration).
   - Generate a CSPRNG token: `randomBytes(32).toString('hex')` (reuse pattern from token-service.ts).
   - Hash it with SHA-256: `createHash('sha256').update(token).digest('hex')`.
   - Store in `prisma.passwordResetToken.create({ data: { tokenHash, userId: user.id, expiresAt: new Date(Date.now() + 60 * 60 * 1000) } })` -- 1 hour expiry.
   - Build reset URL: `${env.APP_URL}/reset-password?token=${token}`.
   - Call `emailService.sendPasswordReset(...)` with the user's email, locale, and reset URL.

2. `resetPassword(rawToken: string, newPassword: string)`:
   - Hash the raw token with SHA-256.
   - **ATOMIC consumption (AUTH-05):** Use `prisma.passwordResetToken.updateMany({ where: { tokenHash, usedAt: null, expiresAt: { gt: new Date() } }, data: { usedAt: new Date() } })`. Check `count === 0` means token was already used, expired, or not found -- return `{ success: false, reason: 'invalid_or_expired' }`.
   - If count === 1: fetch the token to get userId. Hash the new password using the same `hashPassword` function from auth-service.ts (extract it to a shared util or import from auth-service).
   - Update user password: `prisma.user.update({ where: { id: userId }, data: { password: hashedPassword } })`.
   - **Delete ALL refresh tokens** for this user: `prisma.refreshToken.deleteMany({ where: { userId } })` -- ghost session prevention (AUTH-03 session invalidation).
   - Return `{ success: true }`.

Export `hashPassword` and `verifyPassword` from auth-service.ts so password-reset-service.ts can reuse them. Change them from file-private functions to exported functions in auth-service.ts.

**Add routes to auth.ts:**

Add two new routes to the existing `authRoutes` function in `backend/src/api/routes/auth.ts`:

1. `POST /auth/forgot-password` (NO auth required):
   - Schema: body requires `email` (string, format: email).
   - Handler: call `passwordResetService.requestPasswordReset(body.email)`.
   - ALWAYS return 200 with `{ message: 'If an account exists, a reset email has been sent.' }` -- regardless of whether email exists (AUTH-04).

2. `POST /auth/reset-password` (NO auth required):
   - Schema: body requires `token` (string) and `password` (string, minLength: 8).
   - Handler: call `passwordResetService.resetPassword(body.token, body.password)`.
   - If success: return 200 `{ message: 'Password has been reset.' }`.
   - If not success: return 400 `{ message: 'Invalid or expired reset link.' }`.

**Add email template to email-service.ts:**

Add a new `sendPasswordReset` method to emailService:

```typescript
interface PasswordResetEmailInput {
  to: string;
  locale: string;
  resetUrl: string;
}
```

HTML template following existing patterns (inline styles, max-width 600px, escapeHtml):
- Subject: "Reset your password" / "Reinitialiser votre mot de passe" (use tWithLang)
- Body: Greeting, explanation that a password reset was requested, prominent blue CTA button linking to resetUrl, note that link expires in 1 hour, note that if they didn't request it they can ignore the email.
- Add i18n keys to backend locale files if they exist, otherwise use inline FR/EN conditional like existing templates.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/backend && npx tsc --noEmit` -- TypeScript compiles
2. Grep password-reset-service.ts for `updateMany` -- confirms atomic consumption
3. Grep password-reset-service.ts for `deleteMany.*refreshToken` -- confirms session invalidation
4. Grep auth.ts for `forgot-password` and `reset-password` -- confirms routes exist
5. Grep email-service.ts for `sendPasswordReset` -- confirms email template exists
  </verify>
  <done>Backend has password reset service with TOCTOU-safe token consumption, two unauthenticated routes, and email template. Same response returned regardless of email existence. All refresh tokens deleted on password reset.</done>
</task>

<task type="auto">
  <name>Task 2: Forgot password and reset password frontend pages</name>
  <files>frontend/src/pages/ForgotPasswordPage.tsx, frontend/src/pages/ResetPasswordPage.tsx, frontend/src/App.tsx, frontend/src/i18n/locales/en/common.json, frontend/src/i18n/locales/fr/common.json</files>
  <action>
**Create ForgotPasswordPage.tsx:**

Follow LoginPage.tsx layout pattern (centered card, logo, form):
- Single email input field.
- Submit button calling `apiFetch('/auth/forgot-password', { method: 'POST', body: JSON.stringify({ email }) })`.
- On success, show a success message: "If an account exists with that email, a reset link has been sent." (matches backend anti-enumeration message).
- On error, show generic error.
- Link back to login page: "Back to login".
- Use `useTranslation()` for all text via `auth.forgot_*` i18n keys.
- Match the existing LoginPage visual style exactly (bg-gray-50, max-w-md, rounded-lg, shadow, etc.).

**Create ResetPasswordPage.tsx:**

Follow LoginPage.tsx layout pattern:
- Read `token` from URL query params: `useSearchParams()`.
- Two password fields: new password and confirm password.
- Submit: validate passwords match, then `apiFetch('/auth/reset-password', { method: 'POST', body: JSON.stringify({ token, password }) })`.
- On success: show success message with link to login page.
- On error (400 from backend): show "Invalid or expired reset link" with link to forgot-password page.
- Use `auth.reset_*` i18n keys.

**Update App.tsx:**

Add two new public routes (no AuthGuard):
```tsx
<Route path="/forgot-password" element={<ForgotPasswordPage />} />
<Route path="/reset-password" element={<ResetPasswordPage />} />
```

Import the two new page components at the top of App.tsx.

**Update LoginPage.tsx to add forgot password link:**

Add a "Forgot password?" link below the password field (before the submit button), linking to `/forgot-password`. Use i18n key `auth.forgot_password` (already exists in EN locale as "Forgot password?").

**Update i18n locale files:**

Add to `frontend/src/i18n/locales/en/common.json` under the `auth` key:
```json
"forgot_title": "Reset your password",
"forgot_instruction": "Enter your email address and we'll send you a reset link.",
"forgot_submit": "Send reset link",
"forgot_success": "If an account exists with that email, a reset link has been sent.",
"forgot_back": "Back to login",
"reset_title": "Set new password",
"reset_new_password": "New password",
"reset_confirm_password": "Confirm new password",
"reset_submit": "Reset password",
"reset_success": "Your password has been reset. You can now log in.",
"reset_expired": "This reset link is invalid or has expired.",
"reset_go_login": "Go to login",
"reset_go_forgot": "Request a new link",
"name": "Name",
"password_mismatch": "Passwords do not match"
```

Add equivalent French translations under `auth` in `fr/common.json`:
```json
"forgot_title": "Reinitialiser votre mot de passe",
"forgot_instruction": "Entrez votre adresse email et nous vous enverrons un lien de reinitialisation.",
"forgot_submit": "Envoyer le lien",
"forgot_success": "Si un compte existe avec cet email, un lien de reinitialisation a ete envoye.",
"forgot_back": "Retour a la connexion",
"reset_title": "Nouveau mot de passe",
"reset_new_password": "Nouveau mot de passe",
"reset_confirm_password": "Confirmer le mot de passe",
"reset_submit": "Reinitialiser",
"reset_success": "Votre mot de passe a ete reinitialise. Vous pouvez maintenant vous connecter.",
"reset_expired": "Ce lien est invalide ou a expire.",
"reset_go_login": "Aller a la connexion",
"reset_go_forgot": "Demander un nouveau lien"
```

Note: Only add NEW keys. Do not modify or remove existing keys in the locale files.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/frontend && npm run build` -- build succeeds
2. Grep App.tsx for `forgot-password` and `reset-password` routes
3. ForgotPasswordPage.tsx and ResetPasswordPage.tsx exist and import correctly
4. Grep LoginPage.tsx for `forgot-password` link
  </verify>
  <done>ForgotPasswordPage shows email form and success message. ResetPasswordPage accepts token from URL and lets user set new password. Both pages accessible via routes. LoginPage has "Forgot password?" link. All text translated EN/FR.</done>
</task>

</tasks>

<verification>
1. Backend TypeScript compiles: `cd /Users/mmaudet/work/validly/backend && npx tsc --noEmit`
2. Frontend builds: `cd /Users/mmaudet/work/validly/frontend && npm run build`
3. POST /auth/forgot-password route exists with anti-enumeration response
4. POST /auth/reset-password route exists with atomic token consumption
5. Password reset deletes all refresh tokens for the user
6. Two new frontend pages render and link correctly
</verification>

<success_criteria>
- User can request password reset from /forgot-password page
- Backend sends email with reset link (1h expiry, CSPRNG + SHA-256 hash stored)
- Same response returned regardless of email existence (anti-enumeration)
- User can set new password via /reset-password?token=... page
- Token consumption is atomic (updateMany WHERE usedAt IS NULL)
- All refresh tokens deleted on password reset (session invalidation)
- Frontend pages match existing visual style
- All text translated EN/FR
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-03-SUMMARY.md`
</output>
