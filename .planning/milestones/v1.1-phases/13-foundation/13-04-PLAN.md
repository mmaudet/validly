---
phase: 13-foundation
plan: 04
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - backend/src/api/routes/auth.ts
  - backend/src/services/auth-service.ts
  - frontend/src/pages/ProfilePage.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/common.json
autonomous: true
requirements:
  - PROF-01
  - PROF-02
  - PROF-03
  - PROF-04

must_haves:
  truths:
    - "User can view their current display name, email, and locale on the profile page"
    - "User can edit their display name and save it"
    - "User can change their password by providing current password and new password"
    - "User can switch language (EN/FR) from the profile page and the choice persists to database"
    - "Profile page is accessible from the navigation header on all authenticated pages"
  artifacts:
    - path: "backend/src/api/routes/auth.ts"
      provides: "PATCH /auth/profile and POST /auth/change-password routes"
      contains: "change-password"
    - path: "backend/src/services/auth-service.ts"
      provides: "updateProfile and changePassword service methods"
      contains: "changePassword"
    - path: "frontend/src/pages/ProfilePage.tsx"
      provides: "Profile page with name editing, password change, and language switch"
      contains: "ProfilePage"
  key_links:
    - from: "frontend/src/pages/ProfilePage.tsx"
      to: "/api/auth/profile"
      via: "apiFetch PATCH"
      pattern: "apiFetch.*auth/profile"
    - from: "frontend/src/pages/ProfilePage.tsx"
      to: "/api/auth/change-password"
      via: "apiFetch POST"
      pattern: "apiFetch.*change-password"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "/profile"
      via: "Link or navigate in header"
      pattern: "/profile"
---

<objective>
Implement user profile management: backend endpoints for updating profile and changing password, a ProfilePage with name editing, password change form, and language switcher, and a navigation link to the profile from all authenticated pages.

Purpose: Users need to manage their account settings -- change their name, update their password, and switch their preferred language. This also supports the password change security requirement (current password verification + session cleanup).
Output: Working profile page accessible from nav, with name editing, password change, and language switching.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/src/api/routes/auth.ts
@backend/src/services/auth-service.ts
@frontend/src/pages/DashboardPage.tsx
@frontend/src/hooks/useAuth.ts
@frontend/src/App.tsx
@.planning/phases/13-foundation/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Profile update and password change backend endpoints</name>
  <files>backend/src/services/auth-service.ts, backend/src/api/routes/auth.ts</files>
  <action>
**Add service methods to auth-service.ts:**

1. `updateProfile(userId: string, data: { name?: string; locale?: string })`:
   - Validate: name must be 1-100 chars if provided, locale must be 'en' or 'fr' if provided.
   - `prisma.user.update({ where: { id: userId }, data })`.
   - Return the updated user (same shape as getProfile: id, email, name, role, locale, createdAt).

2. `changePassword(userId: string, currentPassword: string, newPassword: string)`:
   - Fetch user by id. Throw AuthError(404) if not found.
   - Verify current password using existing `verifyPassword` function. Throw AuthError(401, 'Current password is incorrect') if wrong.
   - Hash new password using existing `hashPassword` function.
   - Update user password: `prisma.user.update({ where: { id: userId }, data: { password: hashedPassword } })`.
   - **Delete ALL refresh tokens** for this user: `prisma.refreshToken.deleteMany({ where: { userId } })` -- ghost session prevention, same pattern as password reset.
   - Audit: create AuditEvent with action 'PASSWORD_CHANGED'.
   - Return void.

Note: `hashPassword` and `verifyPassword` must be exported from auth-service.ts (Plan 03 also needs this; if Plan 03 already exported them, just use them. If not, export them now).

**Add routes to auth.ts:**

1. `PATCH /auth/profile` (JWT auth required):
   - Schema: body with optional `name` (string, minLength 1) and optional `locale` (string, enum ['en', 'fr']).
   - preHandler: `async (req) => { await req.jwtVerify(); }`
   - Handler: call `authService.updateProfile(user.sub, body)`, return updated user.
   - Response 200 with user object shape.

2. `POST /auth/change-password` (JWT auth required):
   - Schema: body requires `currentPassword` (string), `newPassword` (string, minLength 8).
   - preHandler: `async (req) => { await req.jwtVerify(); }`
   - Handler: call `authService.changePassword(user.sub, body.currentPassword, body.newPassword)`.
   - Return 200 `{ message: 'Password changed successfully.' }`.
   - Catch AuthError and return appropriate status.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/backend && npx tsc --noEmit` -- TypeScript compiles
2. Grep auth.ts for `change-password` and `PATCH.*profile`
3. Grep auth-service.ts for `changePassword` and `updateProfile` and `deleteMany.*refreshToken`
  </verify>
  <done>PATCH /auth/profile updates name and/or locale. POST /auth/change-password verifies current password, hashes new one, deletes all refresh tokens. Both routes require JWT authentication.</done>
</task>

<task type="auto">
  <name>Task 2: ProfilePage frontend with nav link integration</name>
  <files>frontend/src/pages/ProfilePage.tsx, frontend/src/pages/DashboardPage.tsx, frontend/src/App.tsx, frontend/src/i18n/locales/en/common.json, frontend/src/i18n/locales/fr/common.json</files>
  <action>
**Create ProfilePage.tsx:**

Layout: Use the same page structure as DashboardPage (min-h-screen bg-gray-50, header with logo, max-w-5xl container). Include a "Back to dashboard" link.

Three sections in a single-column card layout:

**Section 1: Profile Information**
- Display email (read-only, gray text).
- Editable name field (text input, pre-filled from useAuth user data).
- Save button that calls `apiFetch('/auth/profile', { method: 'PATCH', body: JSON.stringify({ name }) })`.
- Show success toast/message on save. Refresh the user profile in useAuth after save.

**Section 2: Change Password**
- Three fields: current password, new password, confirm new password.
- Submit button calling `apiFetch('/auth/change-password', { method: 'POST', body: JSON.stringify({ currentPassword, newPassword }) })`.
- On success: show success message, clear form fields. NOTE: the backend deletes all refresh tokens, so the user will be logged out on next token refresh. Show a note: "You will be logged out and need to log in with your new password."
- On error (401 from backend): show "Current password is incorrect" inline.

**Section 3: Language Preference**
- Two radio buttons or toggle buttons: English / Francais.
- Pre-selected based on user's current locale from useAuth.
- On change: call `apiFetch('/auth/profile', { method: 'PATCH', body: JSON.stringify({ locale: newLocale }) })`.
- Also call `i18n.changeLanguage(newLocale)` to update the UI immediately.
- Refresh user profile in useAuth after save.

**useAuth update:** After profile PATCH succeeds, call `fetchProfile()` to refresh user data. The existing `fetchProfile` in useAuth already handles this -- just expose it or call it from the component.

**Update DashboardPage.tsx header (PROF-04):**

In the header section of DashboardPage (the bar with logo, bell icon, locale toggle, logout), add a profile link. Add a user icon/button between the locale toggle and the logout button that navigates to `/profile`. Use the user's name or a person icon. Example:
```tsx
<Link to="/profile" className="text-sm text-gray-700 hover:text-gray-900" title={t('nav.profile')}>
  {user?.name}
</Link>
```

**Update App.tsx:**

Add the profile route inside AuthGuard:
```tsx
<Route path="/profile" element={<AuthGuard><ProfilePage /></AuthGuard>} />
```

Import ProfilePage at the top.

**Update i18n locale files:**

Add to EN `common.json`:
```json
"profile": {
  "title": "Profile",
  "info_section": "Profile Information",
  "email_label": "Email",
  "name_label": "Display Name",
  "save_name": "Save",
  "name_saved": "Name updated successfully",
  "password_section": "Change Password",
  "current_password": "Current Password",
  "new_password": "New Password",
  "confirm_password": "Confirm New Password",
  "change_password": "Change Password",
  "password_changed": "Password changed. You will be logged out shortly.",
  "password_wrong": "Current password is incorrect",
  "language_section": "Language",
  "language_saved": "Language updated"
}
```
Also add `"profile": "Profile"` to `nav` section.

Add equivalent French translations to FR `common.json`:
```json
"profile": {
  "title": "Profil",
  "info_section": "Informations du profil",
  "email_label": "Email",
  "name_label": "Nom d'affichage",
  "save_name": "Enregistrer",
  "name_saved": "Nom mis a jour",
  "password_section": "Changer le mot de passe",
  "current_password": "Mot de passe actuel",
  "new_password": "Nouveau mot de passe",
  "confirm_password": "Confirmer le nouveau mot de passe",
  "change_password": "Changer le mot de passe",
  "password_changed": "Mot de passe change. Vous serez deconnecte.",
  "password_wrong": "Mot de passe actuel incorrect",
  "language_section": "Langue",
  "language_saved": "Langue mise a jour"
}
```
Also add `"profile": "Profil"` to `nav` section.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/frontend && npm run build` -- build succeeds
2. Grep App.tsx for `/profile` route
3. Grep DashboardPage.tsx for `/profile` link
4. ProfilePage.tsx exists with three sections
  </verify>
  <done>ProfilePage displays editable name, password change form, and language switcher. Profile is accessible from navigation header on DashboardPage. Language change updates both database and UI. Password change warns about logout.</done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd /Users/mmaudet/work/validly/backend && npx tsc --noEmit`
2. Frontend builds: `cd /Users/mmaudet/work/validly/frontend && npm run build`
3. PATCH /auth/profile and POST /auth/change-password routes exist
4. Profile page accessible at /profile with AuthGuard
5. Navigation link to profile exists in DashboardPage header
6. Language preference persisted to database and UI updates immediately
</verification>

<success_criteria>
- User can view and edit display name from profile page
- User can change password (requires current password verification)
- Password change deletes all refresh tokens (ghost session prevention)
- User can switch language EN/FR, persisted to database, UI updates immediately
- Profile page accessible from navigation on all authenticated pages (via DashboardPage header pattern)
- All text translated EN/FR
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-04-SUMMARY.md`
</output>
