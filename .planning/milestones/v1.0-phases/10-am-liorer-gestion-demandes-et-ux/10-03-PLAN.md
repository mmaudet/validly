---
phase: 10-am-liorer-gestion-demandes-et-ux
plan: 03
type: execute
wave: 2
depends_on: ["10-02"]
files_modified:
  - frontend/src/pages/ActionConfirmPage.tsx
  - frontend/src/pages/ActionErrorPage.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/lib/api.ts
  - frontend/src/i18n/locales/en.json
  - frontend/src/i18n/locales/fr.json
autonomous: true
requirements:
  - ACTION-CONFIRM-SUMMARY
  - DASHBOARD-TABLE-FILTERS
  - DASHBOARD-BADGES

must_haves:
  truths:
    - "Action confirmation page shows workflow title, documents, step name, initiator name before the comment form"
    - "Comment is required for both approve and refuse actions"
    - "Error pages (expired/used/invalid token) show a link back to the dashboard"
    - "Dashboard has two tabs: Mes demandes and A valider"
    - "Dashboard displays workflows in a structured table with columns: title, status, date, current step"
    - "Dashboard has filters: status, date range, text search, initiator"
    - "A valider tab shows a numeric badge with pending action count"
    - "Header shows a notification icon with pending count"
  artifacts:
    - path: "frontend/src/pages/ActionConfirmPage.tsx"
      provides: "Enriched confirmation page with workflow summary"
      contains: "workflowTitle"
    - path: "frontend/src/pages/ActionErrorPage.tsx"
      provides: "Error page with dashboard link"
      contains: "dashboard"
    - path: "frontend/src/pages/DashboardPage.tsx"
      provides: "Table view with filters, tabs, badges"
      contains: "filter"
  key_links:
    - from: "frontend/src/pages/ActionConfirmPage.tsx"
      to: "/api/actions/:token/info"
      via: "useQuery fetch on mount"
      pattern: "actions.*info"
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "/api/workflows"
      via: "useQuery for submissions list"
      pattern: "workflows"
---

<objective>
Frontend: Enriched action confirmation page and improved dashboard with table view, filters, and notification badges.

Purpose: Delivers two of the key UX improvements: (1) validators see full workflow context before confirming their action, and (2) initiators/validators have a powerful, filterable dashboard.
Output: ActionConfirmPage with workflow summary, DashboardPage with table+filters+badges, ActionErrorPage with dashboard link.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-CONTEXT.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-RESEARCH.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-02-SUMMARY.md

@frontend/src/pages/ActionConfirmPage.tsx
@frontend/src/pages/ActionErrorPage.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/src/lib/api.ts
@frontend/src/hooks/useAuth.ts
@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich ActionConfirmPage with workflow summary and fix error pages</name>
  <files>
    frontend/src/pages/ActionConfirmPage.tsx
    frontend/src/pages/ActionErrorPage.tsx
    frontend/src/lib/api.ts
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/fr.json
  </files>
  <action>
    Upgrade the action confirmation page to show workflow context before the form.

    **1. Add API helper in `lib/api.ts`:**
    - Add a function `fetchActionInfo(token: string)` that calls `GET /api/actions/${token}/info` (no auth header — public endpoint)
    - Returns: `{ action, workflowTitle, stepName, phaseName, initiatorName, documents: string[] }`
    - Handle 410 responses: return `{ error: true, reason: string }` so the page can show appropriate error

    **2. Rewrite `ActionConfirmPage.tsx`:**

    On mount, use `useQuery` (TanStack Query) to fetch the action token info:
    ```
    const tokenInfoQuery = useQuery({
      queryKey: ['action-info', token],
      queryFn: () => fetchActionInfo(token!),
      enabled: !!token,
    });
    ```

    Show a loading skeleton while fetching (simple gray placeholder blocks).

    If the token is invalid/expired (410 response), redirect to `/action/error?reason=expired` (or show the error inline).

    When loaded, render BEFORE the comment form:
    - Workflow title (large, bold)
    - Documents list (bulleted or comma-separated)
    - Step name and phase name
    - Initiator name
    - Then the existing comment textarea + submit button

    Keep the comment field required (locked decision: comment obligatoire pour approuver ET refuser).

    After successful submission, show the current success message (inline) — per Claude's discretion, keep the inline success message rather than redirecting.

    **3. Update `ActionErrorPage.tsx`:**

    Add a "Go to dashboard" link/button at the bottom of the error message. Link to `/` (the dashboard route). Use i18n key `action.go_to_dashboard`.

    Style: a simple text link or secondary button below the error explanation.

    **4. Add i18n keys (both EN and FR):**
    - `action.workflow_summary`: "Workflow summary" / "Résumé du workflow"
    - `action.step_label`: "Step" / "Étape"
    - `action.phase_label`: "Phase" / "Phase"
    - `action.initiator_label`: "Requested by" / "Demandé par"
    - `action.documents_label`: "Documents" / "Documents"
    - `action.go_to_dashboard`: "Go to dashboard" / "Aller au tableau de bord"
    - `action.token_expired`: "This link has expired" / "Ce lien a expiré"
    - `action.token_used`: "This link has already been used" / "Ce lien a déjà été utilisé"
    - `action.token_invalid`: "Invalid link" / "Lien invalide"
  </action>
  <verify>
    - `npm run build` (frontend) compiles without errors
    - `grep "fetchActionInfo\|action-info" frontend/src/pages/ActionConfirmPage.tsx` shows the query
    - `grep "workflowTitle\|stepName\|initiatorName" frontend/src/pages/ActionConfirmPage.tsx` shows the summary fields rendered
    - `grep "dashboard" frontend/src/pages/ActionErrorPage.tsx` shows the dashboard link
  </verify>
  <done>ActionConfirmPage shows workflow title, documents, step/phase, initiator before the form. ActionErrorPage has a dashboard link. Comment is required for both approve and refuse.</done>
</task>

<task type="auto">
  <name>Task 2: Dashboard table view with filters, sorting, tabs, and notification badges</name>
  <files>
    frontend/src/pages/DashboardPage.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/fr.json
  </files>
  <action>
    Replace the current card-based dashboard with a structured table view featuring filters and notification badges.

    **1. Dashboard layout overhaul in `DashboardPage.tsx`:**

    Keep the existing two-tab structure ("Mes demandes" / "A valider") but upgrade from cards to a structured table.

    **Tab bar with badge:**
    - "Mes demandes" tab — no badge
    - "A valider" tab — numeric badge (red circle with white text) showing the count of pending actions
    - The count comes from the existing `listPendingForValidator` API response's `total` field
    - Active tab styling: underline or colored background

    **Header notification icon:**
    - In the dashboard header (next to user info or page title), add a bell icon (use an inline SVG or Unicode character) with the same pending count as a small badge overlay
    - This provides at-a-glance awareness even when on the "Mes demandes" tab

    **2. "Mes demandes" tab — table view:**

    Replace the current card list with an HTML `<table>` (or div-based table with Tailwind grid):
    - Columns: Title, Status (with colored badge), Date (formatted), Current Step
    - Status badges: colored pills — green for APPROVED, red for REFUSED, blue for IN_PROGRESS, gray for DRAFT, orange for CANCELLED
    - Rows are clickable — navigate to `/workflows/:id`
    - Sort: default by date descending. Allow clicking column headers for title (alpha) and date (asc/desc) toggle.

    **Filter bar (above the table):**
    - Status dropdown: All / In Progress / Approved / Refused / Cancelled
    - Date range: two date inputs (from/to)
    - Text search: input field filtering on title (debounced, 300ms)
    - Clear filters button

    **Client-side filtering:**
    Use `useMemo` to filter and sort the data:
    ```typescript
    const filtered = useMemo(() => {
      let result = submissions ?? [];
      if (filters.status) result = result.filter(w => w.status === filters.status);
      if (filters.search) {
        const q = filters.search.toLowerCase();
        result = result.filter(w => w.title.toLowerCase().includes(q));
      }
      if (filters.dateFrom) result = result.filter(w => new Date(w.createdAt) >= new Date(filters.dateFrom));
      if (filters.dateTo) result = result.filter(w => new Date(w.createdAt) <= new Date(filters.dateTo));
      // Sort
      result = [...result].sort((a, b) => {
        if (sort.field === 'title') return sort.dir === 'asc' ? a.title.localeCompare(b.title) : b.title.localeCompare(a.title);
        return sort.dir === 'asc' ? new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime() : new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime();
      });
      return result;
    }, [submissions, filters, sort]);
    ```

    **3. "A valider" tab — table view:**

    Same table structure with columns: Workflow Title, Step Name, Initiator, Date
    - Add initiator filter: text input filtering on `step.phase.workflow.initiator.name` or `.email`
    - Status filter not applicable (all are pending by definition)
    - Text search on workflow title
    - Rows are clickable — navigate to `/workflows/:workflowId`

    **4. State management:**
    - Use `useState` for: activeTab, filters (object with status/search/dateFrom/dateTo/initiator), sort (field + direction)
    - Reset filters when switching tabs

    **5. Add i18n keys (both EN and FR):**
    - `dashboard.my_requests`: "My requests" / "Mes demandes"
    - `dashboard.to_validate`: "To validate" / "A valider"
    - `dashboard.filter_status`: "Status" / "Statut"
    - `dashboard.filter_search`: "Search..." / "Rechercher..."
    - `dashboard.filter_date_from`: "From" / "Du"
    - `dashboard.filter_date_to`: "To" / "Au"
    - `dashboard.filter_initiator`: "Initiator" / "Initiateur"
    - `dashboard.clear_filters`: "Clear" / "Effacer"
    - `dashboard.column_title`: "Title" / "Titre"
    - `dashboard.column_status`: "Status" / "Statut"
    - `dashboard.column_date`: "Date" / "Date"
    - `dashboard.column_step`: "Current step" / "Étape courante"
    - `dashboard.column_initiator`: "Initiator" / "Initiateur"
    - `dashboard.no_results`: "No workflows found" / "Aucun workflow trouvé"
    - Status labels: `status.in_progress`, `status.approved`, `status.refused`, `status.cancelled`, `status.draft`

    **6. Responsive design:**
    - Table scrolls horizontally on mobile (wrap in `overflow-x-auto`)
    - Filters stack vertically on mobile (use flex-wrap)
  </action>
  <verify>
    - `npm run build` (frontend) compiles without errors
    - `grep "useMemo\|filter" frontend/src/pages/DashboardPage.tsx` shows client-side filtering
    - `grep "table\|<th\|<td" frontend/src/pages/DashboardPage.tsx` shows table structure (or equivalent div grid)
    - `grep "badge\|pending.*count\|total" frontend/src/pages/DashboardPage.tsx` shows badge logic
  </verify>
  <done>Dashboard has structured table view with sort/filter on both tabs, status/date/search/initiator filters, numeric badge on "A valider" tab, and notification icon in header</done>
</task>

</tasks>

<verification>
- `npm run build` in frontend/ passes with zero errors
- ActionConfirmPage fetches and displays workflow summary before the form
- ActionErrorPage has a visible "Go to dashboard" link
- DashboardPage shows table with columns and filter bar
- Badge count appears on the "A valider" tab
- Filters work client-side (status, search, date range)
- Both EN and FR i18n keys are present
</verification>

<success_criteria>
- Validators see full workflow context (title, docs, step, initiator) before confirming action
- Error pages guide users back to dashboard
- Dashboard displays structured table with sorting and comprehensive filters
- Notification badges provide at-a-glance awareness of pending actions
- All strings are i18n-ized in EN and FR
</success_criteria>

<output>
After completion, create `.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-03-SUMMARY.md`
</output>
