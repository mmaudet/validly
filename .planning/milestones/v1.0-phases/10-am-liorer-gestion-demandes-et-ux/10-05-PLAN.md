---
phase: 10-am-liorer-gestion-demandes-et-ux
plan: 05
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - frontend/src/pages/AdminUsersPage.tsx
  - frontend/src/App.tsx
  - frontend/src/i18n/locales/en.json
  - frontend/src/i18n/locales/fr.json
autonomous: false
requirements:
  - ADMIN-USERS-UI
  - FULL-PHASE-VERIFY

must_haves:
  truths:
    - "Admin users can access a user management page"
    - "Admin can create a new user with email, name, password, and role"
    - "Admin can edit user name and role"
    - "Admin can delete a user (with confirmation)"
    - "Non-admin users cannot access the admin page (redirect or hidden nav)"
    - "All phase 10 features work end-to-end"
  artifacts:
    - path: "frontend/src/pages/AdminUsersPage.tsx"
      provides: "User management page with CRUD operations"
      contains: "AdminUsersPage"
    - path: "frontend/src/App.tsx"
      provides: "Route registration for /admin/users"
      contains: "AdminUsersPage"
  key_links:
    - from: "frontend/src/pages/AdminUsersPage.tsx"
      to: "/api/users"
      via: "useQuery + useMutation for CRUD"
      pattern: "users"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/AdminUsersPage.tsx"
      via: "route definition"
      pattern: "admin.*users"
---

<objective>
Frontend: Admin user management page with full CRUD, plus end-to-end verification checkpoint for all phase 10 features.

Purpose: Completes the user/role administration UI (locked decision) and verifies the entire phase works together.
Output: AdminUsersPage with create/edit/delete user forms, route registered, checkpoint for human verification.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-CONTEXT.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-RESEARCH.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-01-SUMMARY.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-02-SUMMARY.md

@frontend/src/App.tsx
@frontend/src/hooks/useAuth.ts
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdminUsersPage with CRUD operations, route, and nav link</name>
  <files>
    frontend/src/pages/AdminUsersPage.tsx
    frontend/src/App.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/fr.json
  </files>
  <action>
    Build the admin user management page.

    **1. Create `AdminUsersPage.tsx`:**

    **Page layout:**
    - Page title: "User Management" (i18n)
    - A "Create user" button in the top-right corner
    - Below: a table of all users

    **Users table:**
    - Fetch users with `useQuery` calling `GET /api/users` (authenticated)
    - Columns: Name, Email, Role (colored badge), Created date, Actions (edit/delete buttons)
    - Role badges: ADMIN = purple, INITIATEUR = blue, VALIDATEUR = green
    - Loading state: skeleton rows
    - Empty state: "No users found" message

    **Create user form (modal or slide-over):**
    - Use React Hook Form (already in the project)
    - Fields: email (required, email validation), name (required, min 2), password (required, min 6), role (select: ADMIN/INITIATEUR/VALIDATEUR), locale (select: en/fr, default: fr)
    - Submit calls `useMutation` on `POST /api/users`
    - On success: close modal, invalidate users query
    - On error: show error message (e.g., "Email already exists")

    **Edit user (inline or modal):**
    - Click edit button on a row to open an edit form/modal
    - Pre-filled with current name, role, locale
    - Password NOT editable from this form (separate concern)
    - Submit calls `useMutation` on `PATCH /api/users/:id`
    - On success: close, invalidate query

    **Delete user:**
    - Click delete button on a row
    - Open ConfirmDialog (from Plan 04's `components/ui/ConfirmDialog.tsx`): "Delete user?" / "This user will be permanently removed."
    - Import the ConfirmDialog component
    - Submit calls `useMutation` on `DELETE /api/users/:id`
    - Handle 409 error (last admin) gracefully: show "Cannot delete the last admin" message
    - On success: invalidate query

    **2. Register route in `App.tsx`:**
    - Add route: `/admin/users` -> `<AdminUsersPage />`
    - Add a role guard: if `user.role !== 'ADMIN'`, redirect to `/` (dashboard)
    - Use the existing `useAuth` hook to check role

    **3. Add navigation link:**
    - In the app's nav/header component (check where the nav is rendered — might be in `App.tsx` or a Layout component), add a "Users" link visible only to ADMIN role users
    - Link to `/admin/users`
    - Use a simple conditional: `{user?.role === 'ADMIN' && <Link to="/admin/users">{t('nav.users')}</Link>}`

    **4. i18n keys (EN + FR):**
    - `nav.users`: "Users" / "Utilisateurs"
    - `admin.users_title`: "User Management" / "Gestion des utilisateurs"
    - `admin.create_user`: "Create user" / "Créer un utilisateur"
    - `admin.edit_user`: "Edit user" / "Modifier l'utilisateur"
    - `admin.delete_user`: "Delete user" / "Supprimer l'utilisateur"
    - `admin.delete_confirm_title`: "Delete user?" / "Supprimer l'utilisateur ?"
    - `admin.delete_confirm_message`: "This user will be permanently removed." / "Cet utilisateur sera définitivement supprimé."
    - `admin.field_email`: "Email" / "Email"
    - `admin.field_name`: "Name" / "Nom"
    - `admin.field_password`: "Password" / "Mot de passe"
    - `admin.field_role`: "Role" / "Rôle"
    - `admin.field_locale`: "Language" / "Langue"
    - `admin.role_admin`: "Administrator" / "Administrateur"
    - `admin.role_initiateur`: "Initiator" / "Initiateur"
    - `admin.role_validateur`: "Validator" / "Validateur"
    - `admin.no_users`: "No users found" / "Aucun utilisateur trouvé"
    - `admin.last_admin_error`: "Cannot delete the last administrator" / "Impossible de supprimer le dernier administrateur"
    - `admin.email_exists`: "This email is already in use" / "Cet email est déjà utilisé"
  </action>
  <verify>
    - `npm run build` (frontend) compiles without errors
    - `grep "AdminUsersPage" frontend/src/App.tsx` shows route is registered
    - `grep "admin/users" frontend/src/App.tsx` shows the path
    - `grep "useQuery\|useMutation" frontend/src/pages/AdminUsersPage.tsx` shows CRUD operations
    - `grep "ADMIN\|role" frontend/src/pages/AdminUsersPage.tsx` shows role-based logic
  </verify>
  <done>AdminUsersPage shows user table with create/edit/delete, route registered at /admin/users, nav link visible to admins only, role guard prevents non-admin access</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of all phase 10 features</name>
  <files>N/A (verification only)</files>
  <action>
    CHECKPOINT: Human verifies all phase 10 features end-to-end.

    What was built across 5 plans:
    - Schema migrated to 3 roles (ADMIN, INITIATEUR, VALIDATEUR)
    - BullMQ deadline reminder pipeline (queue, worker, scheduler)
    - Initiator email notifications (on validator action + workflow completion)
    - Workflow cancel + manual re-notify endpoints
    - Action token info endpoint
    - Admin user CRUD (backend + frontend)
    - Enriched action confirmation page with workflow summary
    - Dashboard with table view, filters, sorting, badges
    - Workflow detail page with horizontal stepper, step details, PDF preview
    - Cancel/notify actions on detail page with confirmation dialog

    How to verify — start the application: `docker-compose up` or `npm run dev` in both backend and frontend.

    1. Role system: Log in as admin, navigate to /admin/users, verify CRUD works (create user with INITIATEUR role, edit role, delete with confirm dialog). Log in as non-admin, verify /admin/users redirects.

    2. Dashboard: Verify table view (not cards) on "Mes demandes", column sorting, status/date/search filters, "A valider" tab badge count, header notification icon.

    3. Workflow detail: Verify horizontal stepper shows phases, click phases to see step details (validators, actions, comments, dates, quorum, deadline), PDF preview works, cancel action with confirm dialog, notify action sends reminders.

    4. Action confirmation: Open an action link, verify workflow summary (title, docs, step, initiator) before form, submit with comment, check initiator email received.

    5. Error pages: Verify expired token page has "Go to dashboard" link.

    Resume signal: Type "approved" if all features work correctly, or describe any issues found.
  </action>
  <verify>Human confirms all 5 verification areas pass</verify>
  <done>All phase 10 features verified end-to-end: role system, dashboard, workflow detail, action confirmation, and error pages work correctly</done>
</task>

</tasks>

<verification>
- Frontend compiles without errors
- All new routes accessible (admin users page, updated workflow detail, updated dashboard, updated action confirm)
- CRUD operations work on user management page
- Phase 10 features work end-to-end as verified by checkpoint
</verification>

<success_criteria>
- Admin user management page fully functional with CRUD
- Role-based access control enforced (admin-only for user management)
- All phase 10 features verified end-to-end by human
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-05-SUMMARY.md`
</output>
