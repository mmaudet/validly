---
phase: 09-workflow-creation-ui
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - frontend/src/components/workflow/CircuitBuilderStep.tsx
  - frontend/src/components/workflow/PhaseRow.tsx
  - frontend/src/components/workflow/StepRow.tsx
  - frontend/src/pages/WorkflowCreatePage.tsx
autonomous: true
requirements: []
must_haves:
  truths:
    - "User can define a validation circuit with multiple phases"
    - "Each phase contains configurable steps with quorum rules and validator emails"
    - "User can add/remove phases and steps dynamically"
  artifacts:
    - path: "frontend/src/components/workflow/CircuitBuilderStep.tsx"
      provides: "Outer useFieldArray for phases"
      min_lines: 40
    - path: "frontend/src/components/workflow/PhaseRow.tsx"
      provides: "Inner useFieldArray for steps within a phase"
      min_lines: 40
    - path: "frontend/src/components/workflow/StepRow.tsx"
      provides: "Step fields: name, quorum rule, validator emails, deadline"
      min_lines: 50
  key_links:
    - from: "frontend/src/pages/WorkflowCreatePage.tsx"
      to: "CircuitBuilderStep"
      via: "import and render at wizard step 1"
      pattern: "CircuitBuilderStep"
    - from: "frontend/src/components/workflow/CircuitBuilderStep.tsx"
      to: "PhaseRow"
      via: "useFieldArray map to PhaseRow"
      pattern: "useFieldArray.*structure\\.phases"
    - from: "frontend/src/components/workflow/PhaseRow.tsx"
      to: "StepRow"
      via: "useFieldArray map to StepRow"
      pattern: "useFieldArray.*steps"
---

## Objective

Build the dynamic circuit builder — nested form for phases containing steps with quorum rules, validator emails, execution mode, and optional deadlines.

Purpose: Core workflow creation interaction — defining who validates what, in what order, with what rules.
Output: Three components (CircuitBuilderStep, PhaseRow, StepRow) rendering a fully dynamic nested form.

## Context

```
@frontend/src/pages/WorkflowCreatePage.tsx
@frontend/src/lib/api.ts
```

## Task 1: CircuitBuilderStep and PhaseRow Components

**Type:** auto
**Files:**
- `frontend/src/components/workflow/CircuitBuilderStep.tsx` (create)
- `frontend/src/components/workflow/PhaseRow.tsx` (create)

**Action:**

1. **CircuitBuilderStep.tsx** — Uses `useFormContext` + `useFieldArray({ name: 'structure.phases' })`.
   - Renders phases via `fields.map()` → `<PhaseRow key={field.id} index={index} onRemove={() => remove(index)} />`
   - "Add Phase" button. Disable remove when only 1 phase.

2. **PhaseRow.tsx** — MUST be separate component (Rules of Hooks). Uses `useFormContext()` + `useFieldArray({ name: \`structure.phases.${index}.steps\` })`.
   - Phase name input registered as `structure.phases.${index}.name`
   - Maps steps to `<StepRow>`
   - "Add Step" and "Remove Phase" buttons

## Task 2: StepRow Component and Wizard Integration

**Type:** auto
**Files:**
- `frontend/src/components/workflow/StepRow.tsx` (create)
- `frontend/src/pages/WorkflowCreatePage.tsx` (modify)

**Action:**

1. **StepRow.tsx** — Receives phaseIndex, stepIndex, onRemove props. Uses `useFormContext()`.
   - Step name input (required)
   - Execution mode select (SEQUENTIAL / PARALLEL)
   - Quorum rule select (UNANIMITY / MAJORITY / ANY_OF)
   - Quorum count input (shown only when quorumRule is ANY_OF, use `watch()`)
   - Validator emails: array of email inputs with add/remove
   - Deadline hours (optional number input)
   - Remove step button

2. **WorkflowCreatePage.tsx** — Replace circuit builder placeholder with `<CircuitBuilderStep />`

## Verification

- `cd frontend && npx tsc --noEmit` passes
- On wizard step 1 (Circuit), user sees phases with steps
- Can add/remove phases and steps
- Quorum count input appears only for ANY_OF rule
- Can add/remove validator email fields
