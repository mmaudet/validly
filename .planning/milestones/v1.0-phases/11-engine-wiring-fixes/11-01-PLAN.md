---
phase: 11-engine-wiring-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/services/workflow-service.ts
  - backend/src/jobs/reminder-worker.ts
  - backend/src/domain/workflow-types.ts
autonomous: true
requirements: [WF-02, EMAIL-06, INFRA-05]

must_haves:
  truths:
    - "A workflow with PARALLEL steps activates ALL steps in the first phase simultaneously at launch"
    - "When a parallel phase completes and the next phase is also parallel, all its steps activate simultaneously"
    - "In a PARALLEL phase, approving one step does NOT activate a PENDING step — all were already activated"
    - "Validator emails are sent in the validator's preferred locale (not hardcoded French)"
    - "Unregistered validators receive emails in English (fallback locale)"
    - "Reminder emails use the validator's locale for both content and deadline date formatting"
    - "ARCHIVED status is present in the domain WorkflowStatus type"
  artifacts:
    - path: "backend/src/services/workflow-service.ts"
      provides: "Parallel step activation in launch() and tryAdvance(), locale-aware notifyValidators() and notifyCurrentStep()"
      contains: "phaseHasParallel"
    - path: "backend/src/jobs/reminder-worker.ts"
      provides: "Locale-aware reminder emails"
      contains: "localeByEmail"
    - path: "backend/src/domain/workflow-types.ts"
      provides: "Complete WorkflowStatus union including ARCHIVED"
      contains: "ARCHIVED"
  key_links:
    - from: "backend/src/services/workflow-service.ts"
      to: "prisma.user"
      via: "findMany for locale lookup before email loop"
      pattern: "prisma\\.user\\.findMany.*email.*in"
    - from: "backend/src/services/workflow-service.ts"
      to: "backend/src/services/workflow-service.ts"
      via: "launch() notifies ALL IN_PROGRESS steps in phase 0, not just firstStep"
      pattern: "activeSteps.*filter.*IN_PROGRESS"
    - from: "backend/src/jobs/reminder-worker.ts"
      to: "prisma.user"
      via: "findMany for locale lookup before reminder loop"
      pattern: "prisma\\.user\\.findMany.*email.*in"
    - from: "backend/src/services/workflow-service.ts"
      to: "backend/src/services/workflow-service.ts"
      via: "recordAction() loops over result.activatedSteps for notification when advancing to parallel next phase"
      pattern: "result\\.activatedSteps"
---

<objective>
Fix the workflow engine parallel step activation (WF-02), validator email locale resolution (EMAIL-06/INFRA-05), and ARCHIVED domain type gap.

Purpose: These are the three most impactful gaps from the v1.0 audit — parallel workflows silently activate only one step, all validator emails are hardcoded French regardless of preference, and the domain type is out of sync with the Prisma enum.

Output: Corrected workflow-service.ts (parallel launch + tryAdvance + locale-aware notifications), locale-aware reminder-worker.ts, and complete workflow-types.ts.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-engine-wiring-fixes/11-RESEARCH.md
@backend/src/services/workflow-service.ts
@backend/src/jobs/reminder-worker.ts
@backend/src/domain/workflow-types.ts
@backend/src/domain/state-machine.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix parallel step activation in launch() and tryAdvance(), add ARCHIVED to WorkflowStatus</name>
  <files>backend/src/services/workflow-service.ts, backend/src/domain/workflow-types.ts</files>
  <action>
**workflow-types.ts — ARCHIVED type gap:**
Add `| 'ARCHIVED'` to the `WorkflowStatus` type union on line 1. The Prisma enum already has ARCHIVED; this aligns the domain type.

**workflow-service.ts — launch() parallel activation (lines ~97-127):**
In the inner loop that creates step instances, replace the single-step activation logic:

BEFORE:
```typescript
const isFirstStep = pi === 0 && si === 0;
// ...
status: isFirstStep ? 'IN_PROGRESS' : 'PENDING',
```

AFTER: Before the step loop for each phase, check if the phase has parallel steps:
```typescript
const phaseHasParallel = phaseDef.steps.some(
  (s: any) => s.execution === 'PARALLEL'
);
```
Then for each step in phase 0: activate if `phaseHasParallel` (all steps) OR `si === 0` (first step only for sequential). For phases other than 0, all steps remain PENDING:
```typescript
const isActiveStep = pi === 0 && (phaseHasParallel || si === 0);
status: isActiveStep ? 'IN_PROGRESS' : 'PENDING',
```

**workflow-service.ts — post-launch email notifications (lines ~147-165):**
Replace the `firstStep`-only notification block with a loop over ALL IN_PROGRESS steps in the first phase:

BEFORE: Only notifies `firstStep` (index 0).

AFTER:
```typescript
const firstPhase = result.phases[0];
if (firstPhase) {
  const activeSteps = firstPhase.steps.filter((s: any) => s.status === 'IN_PROGRESS');
  for (const step of activeSteps) {
    await notifyValidators(step.id, step.validatorEmails, {
      workflowTitle: result.title,
      documentTitle: result.documents[0]?.document?.title ?? result.title,
      stepName: step.name,
      initiatorName: result.initiator.name,
    });
    if (step.deadline) {
      try {
        await scheduleReminder(step.id, step.deadline);
      } catch (err) {
        console.error('Failed to schedule reminder for step:', err);
      }
    }
  }
}
```

**workflow-service.ts — tryAdvance() sequential activation guard (line ~506-516):**
In the `else if (phaseResult === 'IN_PROGRESS')` branch, guard the next-PENDING-step activation so it only fires for SEQUENTIAL phases:

BEFORE: Unconditionally finds next PENDING step and activates it.

AFTER:
```typescript
} else if (phaseResult === 'IN_PROGRESS') {
  const phaseHasParallel = steps.some((s: any) => s.execution === 'PARALLEL');
  if (!phaseHasParallel) {
    const nextStep = steps.find((s: any) => s.status === 'PENDING');
    if (nextStep) {
      await tx.stepInstance.update({
        where: { id: nextStep.id },
        data: { status: 'IN_PROGRESS' },
      });
      activatedStep = { id: nextStep.id, name: nextStep.name, validatorEmails: nextStep.validatorEmails };
    }
  }
}
```

**workflow-service.ts — tryAdvance() next-phase parallel activation (lines ~476-492):**
When activating the next phase after the current phase completes, check if the next phase is also parallel and activate ALL its steps (not just step 0). Use the `activatedSteps` array approach: add `activatedSteps` to the tryAdvance return type, populate it in the parallel next-phase branch with all activated steps, and leave it empty for sequential next-phase activation (where `activatedStep` singular is used as before).

BEFORE: Only activates `firstStep` (order: 0) of the next phase and returns a single `activatedStep`.

AFTER:
```typescript
if (nextPhase) {
  await tx.phaseInstance.update({ where: { id: nextPhase.id }, data: { status: 'IN_PROGRESS' } });

  const nextPhaseSteps = await tx.stepInstance.findMany({
    where: { phaseId: nextPhase.id },
    orderBy: { order: 'asc' },
  });
  const nextPhaseHasParallel = nextPhaseSteps.some((s: any) => s.execution === 'PARALLEL');

  if (nextPhaseHasParallel) {
    // Activate ALL steps in the parallel next phase
    for (const s of nextPhaseSteps) {
      await tx.stepInstance.update({ where: { id: s.id }, data: { status: 'IN_PROGRESS' } });
    }
    // Populate activatedSteps with all steps for the post-transaction notification loop
    activatedSteps = nextPhaseSteps.map((s: any) => ({
      id: s.id,
      name: s.name,
      validatorEmails: s.validatorEmails,
      deadline: s.deadline,
    }));
  } else {
    // Sequential: activate only first step
    const firstStep = nextPhaseSteps[0];
    if (firstStep) {
      await tx.stepInstance.update({ where: { id: firstStep.id }, data: { status: 'IN_PROGRESS' } });
      activatedStep = { id: firstStep.id, name: firstStep.name, validatorEmails: firstStep.validatorEmails, deadline: firstStep.deadline };
    }
  }

  await tx.workflowInstance.update({ where: { id: workflowId }, data: { currentPhase: nextPhase.order } });
}
```

Update the tryAdvance return type to include `activatedSteps`:
```typescript
// In the return type definition (TryAdvanceResult or equivalent):
activatedStep?: { id: string; name: string; validatorEmails: string[]; deadline?: Date | null };
activatedSteps?: { id: string; name: string; validatorEmails: string[]; deadline?: Date | null }[];
```

Return both from tryAdvance:
```typescript
return { phaseAdvanced, workflowAdvanced, activatedStep, activatedSteps: activatedSteps ?? [] };
```

**workflow-service.ts — recordAction() post-transaction notification block (lines ~302-332):**
Replace the single `result.activatedStep` notification block with a loop over `result.activatedSteps`. For sequential next-phase activation, `activatedSteps` will be empty and `activatedStep` will be set; normalize both into a single array before looping:

```typescript
// Build unified list: activatedSteps (parallel next phase) takes priority;
// fall back to wrapping the singular activatedStep for sequential next phase.
const stepsToNotify =
  result.activatedSteps && result.activatedSteps.length > 0
    ? result.activatedSteps
    : result.activatedStep
    ? [result.activatedStep]
    : [];

for (const step of stepsToNotify) {
  await notifyValidators(step.id, step.validatorEmails, {
    workflowTitle: workflow.title,
    documentTitle: workflow.documents[0]?.document?.title ?? workflow.title,
    stepName: step.name,
    initiatorName: workflow.initiator.name,
  });
  if (step.deadline) {
    try {
      await scheduleReminder(step.id, step.deadline);
    } catch (err) {
      console.error('Failed to schedule reminder for activated step:', err);
    }
  }
}
```

Do NOT change `handleRefusal()` — refusal routing for parallel phases is out of scope for Phase 11 per research recommendation.
  </action>
  <verify>
Run `npx tsc --noEmit` in the backend directory to confirm no type errors. Grep for `'ARCHIVED'` in workflow-types.ts. Grep for `phaseHasParallel` in workflow-service.ts (should appear 3 times: launch, tryAdvance IN_PROGRESS guard, tryAdvance next-phase activation). Grep for `activatedSteps` in workflow-service.ts — should appear in the tryAdvance return type, the parallel next-phase branch that populates it, and the recordAction() notification loop. Run `grep -n "result\.activatedSteps" backend/src/services/workflow-service.ts` — should show the loop in recordAction() that iterates over all activated steps for notification and reminder scheduling. Confirm no hardcoded `locale: 'fr'` remains in notifyValidators or notifyCurrentStep (those are fixed in Task 2).
  </verify>
  <done>
Parallel step activation works in both launch() and tryAdvance(). The launch() method activates all steps in phase 0 when any step has execution=PARALLEL. The tryAdvance() method does NOT activate PENDING steps in a PARALLEL phase. When advancing to a new phase, tryAdvance() checks if the next phase is parallel and activates all its steps, populating `activatedSteps` with every activated step. The tryAdvance() return type includes `activatedSteps` (array). recordAction() loops over all `activatedSteps` (not just the singular `activatedStep`) for notification and reminder scheduling when advancing to a parallel next phase — ensuring every validator in the parallel phase receives their email and deadline reminder. ARCHIVED is in the WorkflowStatus domain type.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix validator email locale resolution in notifyValidators, notifyCurrentStep, and reminder-worker</name>
  <files>backend/src/services/workflow-service.ts, backend/src/jobs/reminder-worker.ts</files>
  <action>
**workflow-service.ts — notifyValidators() (lines ~33-61):**
Add a batch locale lookup BEFORE the token creation and email loop. This query runs OUTSIDE any Prisma transaction (notifyValidators is called after transaction commit).

Insert after `try {` and before `const tokens = ...`:
```typescript
const validatorUsers = await prisma.user.findMany({
  where: { email: { in: validatorEmails } },
  select: { email: true, locale: true },
});
const localeByEmail = new Map(validatorUsers.map(u => [u.email, u.locale]));
```

Then replace `locale: 'fr'` with `locale: localeByEmail.get(email) ?? 'en'` in the `emailService.sendPendingAction()` call.

**workflow-service.ts — notifyCurrentStep() (lines ~659-724):**
Same pattern. After resolving `pendingEmails` (line ~698) and before the `try {` block that creates tokens (line ~705), add the batch locale lookup:
```typescript
const validatorUsers = await prisma.user.findMany({
  where: { email: { in: pendingEmails } },
  select: { email: true, locale: true },
});
const localeByEmail = new Map(validatorUsers.map(u => [u.email, u.locale]));
```

Then replace `locale: 'fr'` on line ~712 with `locale: localeByEmail.get(email) ?? 'en'` in the `emailService.sendManualReminder()` call.

**reminder-worker.ts (lines ~46-76):**
After resolving `pendingEmails` (line ~46) and the early return if empty (line ~51), add the batch locale lookup:
```typescript
const validatorUsers = await prisma.user.findMany({
  where: { email: { in: pendingEmails } },
  select: { email: true, locale: true },
});
const localeByEmail = new Map(validatorUsers.map(u => [u.email, u.locale]));
```

Then:
1. Replace `locale: 'fr'` on line ~65 with `locale` (using the variable from the loop).
2. Add `const locale = localeByEmail.get(email) ?? 'en';` at the top of the `for` loop body.
3. Replace the hardcoded `'fr-FR'` date formatting (line ~59) with locale-aware formatting:
```typescript
const locale = localeByEmail.get(email) ?? 'en';
const deadlineDate = step.deadline
  ? step.deadline.toLocaleDateString(locale === 'fr' ? 'fr-FR' : 'en-GB')
  : '';
```

After all changes, grep the entire backend for `locale: 'fr'` — there should be ZERO remaining instances in workflow-service.ts and reminder-worker.ts.
  </action>
  <verify>
Run `npx tsc --noEmit` in the backend directory. Run `grep -rn "locale: 'fr'" backend/src/services/workflow-service.ts backend/src/jobs/reminder-worker.ts` — should return no matches. Run `grep -rn "localeByEmail" backend/src/services/workflow-service.ts backend/src/jobs/reminder-worker.ts` — should show 3 occurrences (notifyValidators, notifyCurrentStep, reminder-worker).
  </verify>
  <done>
All three notification paths (notifyValidators, notifyCurrentStep, reminder-worker) resolve the validator's preferred locale via a batch Prisma user query before the email loop. Unregistered validators fall back to 'en'. Deadline dates in reminders are formatted using the validator's locale. No hardcoded `locale: 'fr'` remains in notification code.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/mmaudet/work/validly/backend && npx tsc --noEmit` — zero type errors
2. `grep -n "phaseHasParallel" backend/src/services/workflow-service.ts` — appears in launch(), tryAdvance() IN_PROGRESS guard, and tryAdvance() next-phase block
3. `grep -n "activatedSteps" backend/src/services/workflow-service.ts` — appears in return type, parallel next-phase population, and recordAction() notification loop
4. `grep -n "result\.activatedSteps" backend/src/services/workflow-service.ts` — present in recordAction() notification loop
5. `grep -n "localeByEmail" backend/src/services/workflow-service.ts backend/src/jobs/reminder-worker.ts` — 3 occurrences total
6. `grep -n "locale: 'fr'" backend/src/services/workflow-service.ts backend/src/jobs/reminder-worker.ts` — zero matches
7. `grep -n "ARCHIVED" backend/src/domain/workflow-types.ts` — present in WorkflowStatus type
</verification>

<success_criteria>
- TypeScript compiles without errors
- Parallel step activation logic is correct in both launch() and tryAdvance()
- tryAdvance() returns activatedSteps array populated with all steps when advancing to a parallel next phase
- recordAction() loops over result.activatedSteps for notification and reminder scheduling (not just the singular activatedStep)
- Validator locale resolution uses batch Prisma query with 'en' fallback in all 3 notification paths
- ARCHIVED is in WorkflowStatus domain type
- No hardcoded locale: 'fr' in notification code
</success_criteria>

<output>
After completion, create `.planning/phases/11-engine-wiring-fixes/11-01-SUMMARY.md`
</output>
