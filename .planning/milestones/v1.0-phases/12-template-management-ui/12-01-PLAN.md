---
phase: 12-template-management-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/TemplateFormPage.tsx
  - frontend/src/App.tsx
  - frontend/src/i18n/locales/en/common.json
  - frontend/src/i18n/locales/fr/common.json
autonomous: true
requirements:
  - TMPL-01
  - TMPL-02

must_haves:
  truths:
    - "User can navigate to /templates/new and see a template creation form with name, description, and circuit builder"
    - "User can fill out the form and submit to create a template via POST /templates"
    - "User can navigate to /templates/:id/edit and see the form pre-populated with the existing template data"
    - "User can modify and save an existing template via PUT /templates/:id"
    - "Form uses the full CircuitBuilderStep component for defining phases, steps, validators, and quorum rules"
  artifacts:
    - path: "frontend/src/pages/TemplateFormPage.tsx"
      provides: "Unified create/edit template page with FormProvider + CircuitBuilderStep"
      min_lines: 80
    - path: "frontend/src/App.tsx"
      provides: "Routes for /templates/new and /templates/:id/edit"
      contains: "templates"
    - path: "frontend/src/i18n/locales/en/common.json"
      provides: "English template.* i18n keys"
      contains: "template"
    - path: "frontend/src/i18n/locales/fr/common.json"
      provides: "French template.* i18n keys"
      contains: "template"
  key_links:
    - from: "frontend/src/pages/TemplateFormPage.tsx"
      to: "/templates"
      via: "apiFetch POST and PUT mutations"
      pattern: "apiFetch.*templates"
    - from: "frontend/src/pages/TemplateFormPage.tsx"
      to: "frontend/src/components/workflow/CircuitBuilderStep.tsx"
      via: "import and render within FormProvider"
      pattern: "CircuitBuilderStep"
    - from: "frontend/src/pages/TemplateFormPage.tsx"
      to: "frontend/src/pages/WorkflowCreatePage.tsx"
      via: "import PhaseForm and StepForm types"
      pattern: "import.*PhaseForm.*WorkflowCreatePage"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/TemplateFormPage.tsx"
      via: "Route elements with AuthGuard"
      pattern: "TemplateFormPage"
---

<objective>
Create the TemplateFormPage component (unified create + edit) with routes and i18n keys, enabling users to create and edit workflow templates via a structured form that reuses the existing CircuitBuilderStep component.

Purpose: This is the core UI for TMPL-01 and TMPL-02 — users need a form page to create workflow templates defining phases, steps, validators, and quorum rules. The backend API already exists; this plan builds the frontend page.
Output: TemplateFormPage.tsx (new), updated App.tsx routes, updated i18n keys in EN and FR
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-template-management-ui/12-RESEARCH.md

@frontend/src/pages/WorkflowCreatePage.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/src/components/workflow/CircuitBuilderStep.tsx
@frontend/src/components/workflow/TemplatePicker.tsx
@frontend/src/App.tsx
@frontend/src/lib/api.ts
@frontend/src/i18n/locales/en/common.json
@frontend/src/i18n/locales/fr/common.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateFormPage with create and edit mutations</name>
  <files>frontend/src/pages/TemplateFormPage.tsx</files>
  <action>
Create a new `TemplateFormPage` component that serves as both create and edit page, following the WorkflowCreatePage + UsersTab patterns from the codebase.

**Type definition:**
```typescript
import type { PhaseForm, StepForm, ValidatorEmailEntry } from './WorkflowCreatePage';

export interface TemplateForm {
  name: string;
  description: string;
  structure: {
    phases: PhaseForm[];
  };
}
```

**Route param detection:**
- Use `const { id } = useParams<{ id: string }>()` to detect create vs edit mode
- `const isEdit = Boolean(id)`

**Form setup with react-hook-form:**
- `useForm<TemplateForm>` with defaultValues: `{ name: '', description: '', structure: { phases: [{ name: '', steps: [{ name: '', executionMode: 'SEQUENTIAL', quorumRule: 'UNANIMITY', quorumCount: null, validatorEmails: [{ email: '' }], deadlineHours: null }] }] } }`
- Wrap everything in `<FormProvider {...methods}>` so CircuitBuilderStep can use `useFormContext()`

**Edit mode data fetching:**
- `useQuery({ queryKey: ['templates', id], queryFn: () => apiFetch<Template>('/templates/' + id), enabled: isEdit })`
- Import the `Template` type from `../components/workflow/TemplatePicker`
- In a `useEffect` watching `[existing, id, methods]`, call `methods.reset(templateToForm(existing))` when data arrives
- CRITICAL: Use `useEffect` not `onSuccess` on useQuery (TanStack Query v5 removed `onSuccess` from useQuery)

**templateToForm conversion (API -> form shape):**
- `executionMode` field: The Template type from TemplatePicker already uses `executionMode` (not `execution`), so no rename needed on read
- `validatorEmails`: API returns `string[]`, form needs `{ email: string }[]` -- map with `.map(email => ({ email }))`
- `quorumCount` and `deadlineHours`: default to `null` if undefined

**buildTemplatePayload (form -> API payload):**
- `executionMode` -> `execution` (CRITICAL rename per STATE.md decision)
- `validatorEmails`: `{ email }[]` -> `string[]` via `.map(v => v.email)`
- Include `quorumCount` only when `quorumRule === 'ANY_OF'`
- Include `deadlineHours` only when not null
- Match the exact pattern from WorkflowCreatePage's `buildWorkflowPayload` function

**Mutations:**
- Create: `useMutation` calling `apiFetch<Template>('/templates', { method: 'POST', body: JSON.stringify(buildTemplatePayload(data)) })`
- Edit: `useMutation` calling `apiFetch<Template>('/templates/' + id, { method: 'PUT', body: JSON.stringify(buildTemplatePayload(data)) })`
- Both `onSuccess`: `queryClient.invalidateQueries({ queryKey: ['templates'] })` then `navigate('/dashboard')`
- `onError`: set a `submitError` state displayed inline

**Layout (following WorkflowCreatePage header pattern):**
- Header with app name and Cancel button (navigates to /dashboard)
- Page title: `t('template.page_title_create')` or `t('template.page_title_edit')` based on isEdit
- Name input: text input with `register('name', { required: true, minLength: 3 })`
- Description textarea: `register('description')` — optional
- CircuitBuilderStep component (imported, rendered as-is — it uses useFormContext internally)
- Submit button: `t('template.save')`, disabled while mutation is pending
- Error display for submitError

**Error handling for 403:**
- If `err instanceof ApiError && err.status === 403`, show `t('template.error_403')`
- Otherwise show `err.message`

Import ApiError from `../lib/api` (same pattern as DashboardPage).

Do NOT add `isShared` toggle — per research, omit it; it defaults to false on the backend.
  </action>
  <verify>
Run `npx tsc --noEmit` from frontend directory — no type errors. Verify the file imports CircuitBuilderStep, uses FormProvider, has both create and edit mutations, has buildTemplatePayload with executionMode->execution rename, and has templateToForm with validatorEmails string[]->object[] conversion.
  </verify>
  <done>
TemplateFormPage.tsx exists with: TemplateForm type definition, useParams-based create/edit detection, useQuery for edit pre-population via useEffect, buildTemplatePayload with field renames, create and edit useMutation hooks, FormProvider wrapping CircuitBuilderStep, name/description inputs, submit/cancel buttons, 403 error handling. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add routes in App.tsx and i18n keys for template pages</name>
  <files>
    frontend/src/App.tsx
    frontend/src/i18n/locales/en/common.json
    frontend/src/i18n/locales/fr/common.json
  </files>
  <action>
**App.tsx changes:**
1. Import TemplateFormPage: `import { TemplateFormPage } from './pages/TemplateFormPage';`
2. Add two routes inside the `<Routes>` block, after the `/admin/users` route and before `/login`:
   ```
   <Route path="/templates/new" element={<AuthGuard><TemplateFormPage /></AuthGuard>} />
   <Route path="/templates/:id/edit" element={<AuthGuard><TemplateFormPage /></AuthGuard>} />
   ```

**i18n EN (common.json) — add `template` section:**
Add after the existing `"common"` section (or anywhere at root level):
```json
"template": {
  "page_title_create": "New Template",
  "page_title_edit": "Edit Template",
  "name_label": "Template Name",
  "name_placeholder": "e.g. Standard Legal Review",
  "description_label": "Description (optional)",
  "description_placeholder": "Describe when to use this template",
  "save": "Save Template",
  "cancel": "Cancel",
  "create_button": "New Template",
  "edit": "Edit",
  "delete": "Delete",
  "delete_confirm_title": "Delete template?",
  "delete_confirm_message": "This template will be permanently removed.",
  "no_templates": "No templates yet. Create your first template!",
  "column_name": "Name",
  "column_description": "Description",
  "column_actions": "Actions",
  "error_403": "You can only edit or delete your own templates"
}
```

**i18n FR (common.json) — add `template` section:**
```json
"template": {
  "page_title_create": "Nouveau modele",
  "page_title_edit": "Modifier le modele",
  "name_label": "Nom du modele",
  "name_placeholder": "ex. Revue juridique standard",
  "description_label": "Description (optionnel)",
  "description_placeholder": "Decrivez quand utiliser ce modele",
  "save": "Enregistrer le modele",
  "cancel": "Annuler",
  "create_button": "Nouveau modele",
  "edit": "Modifier",
  "delete": "Supprimer",
  "delete_confirm_title": "Supprimer le modele ?",
  "delete_confirm_message": "Ce modele sera definitivement supprime.",
  "no_templates": "Aucun modele. Creez votre premier modele !",
  "column_name": "Nom",
  "column_description": "Description",
  "column_actions": "Actions",
  "error_403": "Vous ne pouvez modifier ou supprimer que vos propres modeles"
}
```

Note: Use proper French accents (e with accent, etc.) matching the existing i18n file encoding patterns. The existing FR file uses unicode escapes for accents in some places and raw UTF-8 in others — match the surrounding style (the wizard section uses raw UTF-8, so use raw UTF-8 for template keys too).
  </action>
  <verify>
Run `npx tsc --noEmit` from frontend directory — no type errors. Verify App.tsx has both template routes. Verify both common.json files have the `template` section with all 17 keys. Verify JSON is valid: `node -e "JSON.parse(require('fs').readFileSync('frontend/src/i18n/locales/en/common.json'))"` and same for fr.
  </verify>
  <done>
App.tsx has /templates/new and /templates/:id/edit routes with AuthGuard. Both EN and FR common.json files have complete template.* i18n keys (17 keys each). All JSON is valid. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with no errors
2. TemplateFormPage.tsx exists and imports CircuitBuilderStep, PhaseForm, StepForm from existing files
3. App.tsx has both /templates/new and /templates/:id/edit routes
4. EN and FR common.json both have template.* namespace with matching key sets
5. buildTemplatePayload correctly renames executionMode to execution
6. templateToForm correctly converts validatorEmails from string[] to { email }[]
</verification>

<success_criteria>
- TemplateFormPage renders in create mode at /templates/new with empty form
- TemplateFormPage renders in edit mode at /templates/:id/edit with pre-populated form
- Form includes name input, description textarea, and full CircuitBuilderStep
- Create submits POST /templates with correct payload shape
- Edit submits PUT /templates/:id with correct payload shape
- Both mutations invalidate ['templates'] query cache on success
- All template.* i18n keys present in both EN and FR
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-template-management-ui/12-01-SUMMARY.md`
</output>
