---
phase: 10-am-liorer-gestion-demandes-et-ux
plan: 04
type: execute
wave: 2
depends_on: ["10-01", "10-02"]
files_modified:
  - frontend/src/pages/WorkflowDetailPage.tsx
  - frontend/src/components/workflow/WorkflowStepper.tsx
  - frontend/src/components/workflow/StepDetail.tsx
  - frontend/src/components/workflow/DocumentPreview.tsx
  - frontend/src/components/ui/ConfirmDialog.tsx
  - frontend/src/i18n/locales/en.json
  - frontend/src/i18n/locales/fr.json
  - frontend/package.json
autonomous: true
requirements:
  - WORKFLOW-STEPPER
  - STEP-DETAIL
  - PDF-PREVIEW
  - INITIATOR-ACTIONS-UI

must_haves:
  truths:
    - "Workflow detail page shows a horizontal stepper visualizing phase progression"
    - "Clicking a phase in the stepper shows step details below: validators, actions, comments, dates, quorum rule, deadline"
    - "Initiator can cancel an in-progress workflow from the detail page with a confirmation dialog"
    - "Initiator can manually re-send notifications to pending validators from the detail page"
    - "PDF documents show inline preview using react-pdf"
    - "Non-PDF documents show a download link"
    - "Documents section shows a list with preview and download"
  artifacts:
    - path: "frontend/src/components/workflow/WorkflowStepper.tsx"
      provides: "Horizontal stepper component"
      contains: "WorkflowStepper"
    - path: "frontend/src/components/workflow/StepDetail.tsx"
      provides: "Step detail panel showing validators, actions, comments"
      contains: "StepDetail"
    - path: "frontend/src/components/workflow/DocumentPreview.tsx"
      provides: "PDF inline preview component using react-pdf"
      contains: "Document"
    - path: "frontend/src/components/ui/ConfirmDialog.tsx"
      provides: "Reusable confirmation dialog"
      contains: "ConfirmDialog"
  key_links:
    - from: "frontend/src/pages/WorkflowDetailPage.tsx"
      to: "frontend/src/components/workflow/WorkflowStepper.tsx"
      via: "component import and render"
      pattern: "WorkflowStepper"
    - from: "frontend/src/pages/WorkflowDetailPage.tsx"
      to: "/api/workflows/:id/cancel"
      via: "useMutation for cancel action"
      pattern: "cancel"
    - from: "frontend/src/pages/WorkflowDetailPage.tsx"
      to: "/api/workflows/:id/notify"
      via: "useMutation for re-notify action"
      pattern: "notify"
    - from: "frontend/src/components/workflow/DocumentPreview.tsx"
      to: "/api/documents/:id/file"
      via: "PDF.js fetch with auth header"
      pattern: "documents.*file"
---

<objective>
Frontend: Enriched workflow detail page with horizontal stepper, step details, PDF preview, and initiator actions (cancel/re-notify).

Purpose: Transforms the workflow detail page into a comprehensive tracking view where initiators can see full progression, preview documents, and take management actions.
Output: WorkflowStepper, StepDetail, DocumentPreview, ConfirmDialog components wired into WorkflowDetailPage.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-CONTEXT.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-RESEARCH.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-01-SUMMARY.md
@.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-02-SUMMARY.md

@frontend/src/pages/WorkflowDetailPage.tsx
@frontend/src/lib/api.ts
@frontend/src/hooks/useAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: WorkflowStepper, StepDetail components, and wire into detail page</name>
  <files>
    frontend/src/components/workflow/WorkflowStepper.tsx
    frontend/src/components/workflow/StepDetail.tsx
    frontend/src/pages/WorkflowDetailPage.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/fr.json
  </files>
  <action>
    Build the horizontal stepper and step detail panel, then integrate into WorkflowDetailPage.

    **1. Create `WorkflowStepper.tsx`:**

    Props: `{ phases: PhaseData[], activePhaseId: string | null, onSelectPhase: (id: string) => void }`

    Where `PhaseData` = `{ id: string, name: string, status: string, order: number }`

    Render a horizontal flex row of phase indicators connected by lines:
    - Each phase: a circle (h-10 w-10 rounded-full) with the phase number inside
    - Color by status:
      - APPROVED: `bg-green-500 text-white`
      - REFUSED: `bg-red-500 text-white`
      - IN_PROGRESS: `bg-blue-500 text-white`
      - PENDING: `bg-gray-200 text-gray-500`
    - Below each circle: phase name (text-xs, truncated, max-w-[100px])
    - Between circles: a horizontal line (`h-0.5 flex-1`) colored green if previous phase is APPROVED, gray otherwise
    - Active/selected phase: add a ring (`ring-2 ring-blue-500 ring-offset-2`)
    - Each circle is a `<button>` calling `onSelectPhase(phase.id)` on click

    **2. Create `StepDetail.tsx`:**

    Props: `{ phase: PhaseWithSteps }` where PhaseWithSteps includes steps with their actions.

    For each step in the phase, render a card/section:
    - Step name (bold) + status badge (colored pill, same color scheme as stepper)
    - Execution mode: "Sequential" or "Parallel" (small label)
    - Quorum rule display: "Unanimity" / "Majority" / "Any X of Y" (use quorumRule + quorumCount + validatorEmails.length)
    - Deadline: formatted date or "No deadline" (use `toLocaleDateString`)
    - Validator list: show each validator email with an icon indicating:
      - Acted + APPROVE: green checkmark
      - Acted + REFUSE: red X
      - Not acted: gray clock/pending icon
    - Actions list: for each action on the step, show:
      - Actor email + action type (APPROVE/REFUSE) + comment + date
      - Format: `"user@example.com approved on 2026-02-19: 'Looks good'"` (use card-like layout)

    **3. Wire into `WorkflowDetailPage.tsx`:**

    Add state: `const [selectedPhaseId, setSelectedPhaseId] = useState<string | null>(null)`
    - Default: set to the first IN_PROGRESS phase, or the last phase if workflow is complete

    Render the page in this order:
    1. **Workflow header**: Title, status badge, initiator name, creation date (keep existing or enhance)
    2. **WorkflowStepper**: phases from the workflow data, selectedPhaseId, onSelectPhase
    3. **StepDetail**: pass the selected phase (with steps and actions) from the workflow query data
    4. **Documents section** (handled in Task 2)
    5. **Initiator actions** (handled in Task 2)

    The existing WorkflowDetailPage already fetches the workflow with phases/steps/actions via `useQuery`. Reuse this data — do not add a second query.

    **4. i18n keys (EN + FR):**
    - `workflow.stepper_title`: "Progression" / "Progression"
    - `workflow.step_detail`: "Step details" / "Détails de l'étape"
    - `workflow.quorum_unanimity`: "Unanimity" / "Unanimité"
    - `workflow.quorum_majority`: "Majority" / "Majorité"
    - `workflow.quorum_any_of`: "{{count}} of {{total}}" / "{{count}} sur {{total}}"
    - `workflow.execution_sequential`: "Sequential" / "Séquentiel"
    - `workflow.execution_parallel`: "Parallel" / "Parallèle"
    - `workflow.no_deadline`: "No deadline" / "Pas de deadline"
    - `workflow.deadline_label`: "Deadline" / "Date limite"
    - `workflow.validators`: "Validators" / "Validateurs"
    - `workflow.actions_history`: "Actions" / "Actions"
    - `workflow.pending_action`: "Pending" / "En attente"
    - `workflow.acted_on`: "on" / "le" (date connector)
  </action>
  <verify>
    - `npm run build` (frontend) compiles without errors
    - `grep "WorkflowStepper" frontend/src/pages/WorkflowDetailPage.tsx` shows stepper is used
    - `grep "StepDetail" frontend/src/pages/WorkflowDetailPage.tsx` shows detail panel is used
    - `grep "onSelectPhase\|selectedPhaseId" frontend/src/pages/WorkflowDetailPage.tsx` shows phase selection state
  </verify>
  <done>Workflow detail page shows horizontal stepper with clickable phases, step detail panel shows validators/actions/comments/dates/quorum/deadline for selected phase</done>
</task>

<task type="auto">
  <name>Task 2: DocumentPreview, ConfirmDialog, and initiator actions (cancel/notify)</name>
  <files>
    frontend/src/components/workflow/DocumentPreview.tsx
    frontend/src/components/ui/ConfirmDialog.tsx
    frontend/src/pages/WorkflowDetailPage.tsx
    frontend/src/i18n/locales/en.json
    frontend/src/i18n/locales/fr.json
    frontend/package.json
  </files>
  <action>
    Add PDF preview, confirmation dialog, and wire cancel/notify actions into the detail page.

    **1. Install react-pdf:**
    ```bash
    cd frontend && npm install react-pdf
    ```

    **2. Create `DocumentPreview.tsx`:**

    Props: `{ documentId: string, mimeType: string, fileName: string }`

    - If `mimeType === 'application/pdf'`:
      - Use `react-pdf` Document + Page components
      - Configure the PDF.js worker at module level:
        ```typescript
        import { Document, Page, pdfjs } from 'react-pdf';
        import 'react-pdf/dist/Page/AnnotationLayer.css';
        import 'react-pdf/dist/Page/TextLayer.css';

        pdfjs.GlobalWorkerOptions.workerSrc = new URL(
          'pdfjs-dist/build/pdf.worker.min.mjs',
          import.meta.url,
        ).toString();
        ```
      - Fetch the file from `/api/documents/${documentId}/file` with Authorization header
      - Show all pages in a scrollable container (`max-h-[600px] overflow-auto`)
      - Handle loading state (spinner) and error state (fallback to download link)
      - Track page count with `onLoadSuccess`
    - If not PDF (image or other):
      - For images (`mimeType.startsWith('image/')`) — show an `<img>` tag with the file URL + auth header (use a blob URL created from fetch)
      - For other types — show only a download link

    - Always show a download button/link below the preview

    **3. Create `ConfirmDialog.tsx`:**

    Props: `{ open: boolean, title: string, message: string, confirmLabel?: string, cancelLabel?: string, variant?: 'danger' | 'default', onConfirm: () => void, onCancel: () => void }`

    - If `!open`, return null
    - Render a fixed overlay (`fixed inset-0 z-50 bg-black/40`) with a centered modal
    - Modal content: title (h3, semibold), message (p, text-sm), two buttons (cancel + confirm)
    - Variant 'danger': confirm button is red (`bg-red-600`). Default: blue (`bg-blue-600`).
    - Cancel button: ghost style (`text-gray-600`)
    - Click outside the modal (on the overlay) calls `onCancel`
    - No external library — pure Tailwind + React

    **4. Wire documents section into `WorkflowDetailPage.tsx`:**

    Below the stepper/step detail, add a "Documents" section:
    - List all workflow documents with title and file icon
    - For each document, render `<DocumentPreview>` or just show it in a list with a button to toggle preview
    - Claude's discretion: use an expandable accordion per document — click to expand shows the preview inline, collapsed shows title + download link

    **5. Wire cancel and notify actions into `WorkflowDetailPage.tsx`:**

    Only show these actions if the current user is the workflow initiator AND the workflow is `IN_PROGRESS`.

    **Cancel action:**
    - A "Cancel workflow" button (red/danger styling)
    - On click: open `<ConfirmDialog>` with title "Cancel workflow?" and message "This will cancel the workflow and invalidate all pending action links. This cannot be undone."
    - On confirm: call `useMutation` hitting `PATCH /api/workflows/${id}/cancel`
    - On success: invalidate the workflow query to refetch, show success toast (or just refetch — the status will update)
    - On error: show error message

    **Notify action:**
    - A "Send reminders" button (secondary styling)
    - On click: call `useMutation` hitting `POST /api/workflows/${id}/notify`
    - On success: show a brief success message ("Notifications sent")
    - On error: show error message (e.g., "All validators have already acted")
    - Disable button briefly after success to prevent rapid re-clicks (2s cooldown)

    **6. i18n keys (EN + FR):**
    - `workflow.documents`: "Documents" / "Documents"
    - `workflow.download`: "Download" / "Télécharger"
    - `workflow.preview`: "Preview" / "Aperçu"
    - `workflow.cancel_title`: "Cancel workflow" / "Annuler le workflow"
    - `workflow.cancel_message`: "This will cancel the workflow and invalidate all pending action links. This cannot be undone." / "Cela annulera le workflow et invalidera tous les liens d'action en attente. Cette action est irréversible."
    - `workflow.cancel_button`: "Cancel workflow" / "Annuler le workflow"
    - `workflow.cancel_confirm`: "Confirm cancellation" / "Confirmer l'annulation"
    - `workflow.notify_button`: "Send reminders" / "Relancer les validateurs"
    - `workflow.notify_success`: "Notifications sent" / "Notifications envoyées"
    - `dialog.cancel`: "Cancel" / "Annuler"
    - `dialog.confirm`: "Confirm" / "Confirmer"
  </action>
  <verify>
    - `npm run build` (frontend) compiles without errors
    - `grep "react-pdf" frontend/package.json` shows it's installed
    - `grep "DocumentPreview" frontend/src/pages/WorkflowDetailPage.tsx` shows it's used
    - `grep "ConfirmDialog" frontend/src/pages/WorkflowDetailPage.tsx` shows dialog is used
    - `grep "cancel\|notify" frontend/src/pages/WorkflowDetailPage.tsx` shows both mutations
  </verify>
  <done>Documents show inline PDF preview with download link, cancel action uses confirmation dialog, notify action re-sends emails, both actions restricted to initiator of in-progress workflows</done>
</task>

</tasks>

<verification>
- `npm run build` in frontend/ passes with zero errors
- WorkflowDetailPage renders: stepper, step details, documents with PDF preview, cancel/notify actions
- Stepper correctly colors phases by status
- Step detail shows all required fields (validators, actions, comments, dates, quorum, deadline)
- PDF preview renders inline for PDF documents
- Cancel action shows confirmation dialog before executing
- Notify action sends reminders and shows feedback
</verification>

<success_criteria>
- Horizontal stepper visualizes phase progression with status colors
- Click on phase shows detailed step information
- PDF documents preview inline via react-pdf
- Non-PDF documents show download link
- Initiator can cancel workflow (with confirmation dialog)
- Initiator can manually re-send notifications
- All strings i18n-ized in EN and FR
</success_criteria>

<output>
After completion, create `.planning/phases/10-am-liorer-gestion-demandes-et-ux/10-04-SUMMARY.md`
</output>
