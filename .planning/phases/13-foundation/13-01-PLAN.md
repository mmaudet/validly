---
phase: 13-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/prisma/schema.prisma
  - backend/prisma/migrations/*
  - frontend/src/lib/api.ts
  - frontend/package.json
autonomous: true
requirements:
  - AUTH-06

must_haves:
  truths:
    - "apiFetch does not set Content-Type header when body is null or undefined"
    - "Prisma schema contains PasswordResetToken, Notification, and WorkflowComment models"
    - "Database migration applies cleanly with prisma migrate dev"
    - "Frontend packages docx-preview, dompurify, react-error-boundary, zod, and @hookform/resolvers are installed"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "Fixed apiFetch that conditionally sets Content-Type"
      contains: "body != null"
    - path: "backend/prisma/schema.prisma"
      provides: "PasswordResetToken, Notification, WorkflowComment models"
      contains: "model PasswordResetToken"
  key_links:
    - from: "frontend/src/lib/api.ts"
      to: "Fastify backend"
      via: "fetch with conditional Content-Type"
      pattern: "body.*null|body.*undefined"
---

<objective>
Set up all shared infrastructure for Phase 13: Prisma schema migration with three new models (PasswordResetToken, Notification, WorkflowComment), fix the apiFetch Content-Type bug that causes Fastify empty-body errors, and install all new frontend npm packages needed across the phase.

Purpose: Every other plan in this phase depends on this infrastructure being in place -- the password reset feature needs the PasswordResetToken model, future phases need Notification and WorkflowComment, and the apiFetch fix is a prerequisite for any DELETE/POST-without-body calls.
Output: Updated Prisma schema with migration applied, fixed api.ts, all new npm packages installed.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/prisma/schema.prisma
@frontend/src/lib/api.ts
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema migration with three new models</name>
  <files>backend/prisma/schema.prisma</files>
  <action>
Add three new models to the Prisma schema in a single migration:

1. **PasswordResetToken** model:
   - `id` String @id @default(cuid())
   - `tokenHash` String @unique @map("token_hash")
   - `userId` String @map("user_id")
   - `expiresAt` DateTime @map("expires_at")
   - `usedAt` DateTime? @map("used_at")
   - `createdAt` DateTime @default(now()) @map("created_at")
   - Relation: `user User @relation(fields: [userId], references: [id], onDelete: Cascade)`
   - Index on `userId`
   - @@map("password_reset_tokens")
   - Add `passwordResetTokens PasswordResetToken[]` to User model

2. **Notification** model:
   - `id` String @id @default(cuid())
   - `userId` String @map("user_id")
   - `type` String (NOT enum -- stored as plain string per v1.1 constraint to avoid migration pitfalls)
   - `workflowId` String? @map("workflow_id")
   - `stepId` String? @map("step_id")
   - `metadata` Json?
   - `readAt` DateTime? @map("read_at")
   - `createdAt` DateTime @default(now()) @map("created_at")
   - Relation: `user User @relation(fields: [userId], references: [id], onDelete: Cascade)`
   - Index on `[userId, readAt]`
   - @@map("notifications")
   - Add `notifications Notification[]` to User model

3. **WorkflowComment** model:
   - `id` String @id @default(cuid())
   - `workflowId` String @map("workflow_id")
   - `authorId` String @map("author_id")
   - `body` String
   - `createdAt` DateTime @default(now()) @map("created_at")
   - Relation to WorkflowInstance: `workflow WorkflowInstance @relation(fields: [workflowId], references: [id], onDelete: Cascade)`
   - Relation to User: `author User @relation(fields: [authorId], references: [id])`
   - Index on `workflowId`
   - @@map("workflow_comments")
   - Add `comments WorkflowComment[]` to both User and WorkflowInstance models

Run `npx prisma migrate dev --name add-password-reset-notification-comment` from the backend directory.

IMPORTANT: Notification.type is a String, NOT a Prisma enum. This is a locked constraint from the v1.1 research to avoid enum migration pitfalls.
  </action>
  <verify>Run `npx prisma migrate dev --name add-password-reset-notification-comment` from backend/ directory. Migration should apply cleanly. Then run `npx prisma generate` to confirm client generation succeeds. Verify the migration SQL file exists in backend/prisma/migrations/.</verify>
  <done>Three new models exist in schema.prisma, migration applied to database, Prisma Client regenerated with new types available.</done>
</task>

<task type="auto">
  <name>Task 2: Fix apiFetch Content-Type bug and install all new npm packages</name>
  <files>frontend/src/lib/api.ts, frontend/package.json</files>
  <action>
**apiFetch fix (AUTH-06):**
In `frontend/src/lib/api.ts`, change the Content-Type logic in the `doFetch` function. Currently it sets `Content-Type: application/json` for all non-FormData bodies, including when body is null/undefined. This causes Fastify to reject requests with empty bodies (e.g., DELETE requests) because it tries to parse an empty string as JSON.

Replace:
```
if (!(options?.body instanceof FormData)) {
  headers['Content-Type'] = 'application/json';
}
```

With:
```
if (options?.body != null && !(options.body instanceof FormData)) {
  headers['Content-Type'] = 'application/json';
}
```

The `!= null` check covers both `null` and `undefined`, ensuring Content-Type is only set when there is an actual body payload. This also means existing callers that pass `body: '{}'` for DELETE requests (the workaround from Phase 12) will continue to work, but new code can simply omit the body.

**Install new npm packages:**
From the frontend directory, install:
- `zod` (form validation schemas)
- `@hookform/resolvers` (connects Zod to react-hook-form)
- `docx-preview` (DOCX to HTML rendering)
- `dompurify` (HTML sanitization for DOCX output)
- `@types/dompurify` (TypeScript types, devDependency)
- `react-error-boundary` (React error boundary component)

Run: `npm install zod @hookform/resolvers docx-preview dompurify react-error-boundary && npm install -D @types/dompurify`
  </action>
  <verify>Run `cd /Users/mmaudet/work/validly/frontend && npm run build` to verify TypeScript compilation and Vite build succeed with the updated api.ts and new packages. Check that `node -e "require.resolve('zod')"` and similar work for all new packages.</verify>
  <done>apiFetch only sets Content-Type when body is non-null. All six new npm packages installed and build passes.</done>
</task>

</tasks>

<verification>
1. `cd /Users/mmaudet/work/validly/backend && npx prisma migrate status` shows no pending migrations
2. `cd /Users/mmaudet/work/validly/frontend && npm run build` succeeds
3. Grep `frontend/src/lib/api.ts` for `body != null` confirms the fix
4. Grep `backend/prisma/schema.prisma` for `model PasswordResetToken`, `model Notification`, `model WorkflowComment`
</verification>

<success_criteria>
- Prisma schema has PasswordResetToken, Notification, WorkflowComment models
- Migration applied cleanly to database
- apiFetch only sets Content-Type: application/json when body is non-null
- All new npm packages installed: zod, @hookform/resolvers, docx-preview, dompurify, react-error-boundary
- Frontend build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-01-SUMMARY.md`
</output>
