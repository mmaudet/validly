---
phase: 13-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - 13-01
files_modified:
  - frontend/src/components/workflow/DocumentPreview.tsx
autonomous: true
requirements:
  - DOCX-01
  - DOCX-02
  - DOCX-03

must_haves:
  truths:
    - "DOCX files render as HTML in the browser preview area without triggering a download"
    - "DOCX preview HTML is sanitized through DOMPurify before insertion into the DOM"
    - "docx-preview library is loaded via dynamic import, not included in main bundle"
  artifacts:
    - path: "frontend/src/components/workflow/DocumentPreview.tsx"
      provides: "DOCX rendering branch alongside existing PDF and image branches"
      contains: "docx-preview"
  key_links:
    - from: "frontend/src/components/workflow/DocumentPreview.tsx"
      to: "docx-preview"
      via: "dynamic import()"
      pattern: "import\\(.*docx-preview"
    - from: "frontend/src/components/workflow/DocumentPreview.tsx"
      to: "dompurify"
      via: "DOMPurify.sanitize()"
      pattern: "DOMPurify\\.sanitize"
---

<objective>
Add DOCX file preview capability to the existing DocumentPreview component, rendering DOCX files as sanitized HTML in-browser without triggering a download.

Purpose: Users upload DOCX files for validation workflows. Currently these show only a download link. After this plan, DOCX files render inline like PDFs and images, improving the review experience.
Output: Extended DocumentPreview.tsx with DOCX rendering via docx-preview + DOMPurify sanitization.
</objective>

<execution_context>
@/Users/mmaudet/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mmaudet/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/components/workflow/DocumentPreview.tsx
@.planning/phases/13-foundation/13-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DOCX preview branch to DocumentPreview component</name>
  <files>frontend/src/components/workflow/DocumentPreview.tsx</files>
  <action>
Extend the DocumentPreview component to handle DOCX files (mimeType `application/vnd.openxmlformats-officedocument.wordprocessingml.document`).

**Implementation approach:**

1. Add a new state variable: `const [docxHtml, setDocxHtml] = useState<string | null>(null);`

2. In the existing `useEffect`, add a branch for the DOCX mimeType. The DOCX mimeType string is: `application/vnd.openxmlformats-officedocument.wordprocessingml.document`

3. Update the condition at line 37 to also include DOCX:
```typescript
const isDocx = mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
if (mimeType === 'application/pdf' || mimeType.startsWith('image/') || isDocx) {
```

4. In the `.then((buffer) => { ... })` callback, add a DOCX branch:
```typescript
if (isDocx) {
  // Dynamic import to keep docx-preview out of main bundle (DOCX-03)
  Promise.all([
    import('docx-preview'),
    import('dompurify'),
  ]).then(([docxModule, dompurifyModule]) => {
    const container = document.createElement('div');
    docxModule.renderAsync(buffer, container, undefined, {
      className: 'docx-preview',
      inWrapper: false,
    }).then(() => {
      const DOMPurify = dompurifyModule.default;
      // Sanitize rendered HTML to prevent XSS (DOCX-02)
      const sanitized = DOMPurify.sanitize(container.innerHTML, {
        USE_PROFILES: { html: true },
        ADD_TAGS: ['style'],
      });
      setDocxHtml(sanitized);
      setLoading(false);
    });
  }).catch((err: Error) => {
    setError(err.message);
    setLoading(false);
  });
} else if (mimeType === 'application/pdf') {
```

5. In the `renderPreview()` function, add a DOCX rendering branch BEFORE the PDF check:
```typescript
if (isDocx && docxHtml) {
  return (
    <div
      className="max-h-[600px] overflow-auto bg-white p-4"
      dangerouslySetInnerHTML={{ __html: docxHtml }}
    />
  );
}
```

6. Compute `isDocx` at the component level (not just inside useEffect) so it can be used in renderPreview:
```typescript
const isDocx = mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
```

7. Reset `docxHtml` to null in the cleanup/re-render path when documentId or mimeType changes.

IMPORTANT: Use dynamic `import()` for both docx-preview and dompurify -- this keeps them out of the main Vite bundle (DOCX-03 requirement). The `renderAsync` function from docx-preview takes an ArrayBuffer and renders into a DOM container. DOMPurify.sanitize() is called on the resulting innerHTML before setting state (DOCX-02 XSS prevention requirement).

Do NOT use `useRef` for the container -- render to a detached DOM element, sanitize the output, then set as state for React to render via dangerouslySetInnerHTML. This is safer because we control exactly what HTML enters the DOM.
  </action>
  <verify>
1. `cd /Users/mmaudet/work/validly/frontend && npm run build` -- build succeeds
2. Grep DocumentPreview.tsx for `import('docx-preview')` -- confirms dynamic import
3. Grep DocumentPreview.tsx for `DOMPurify.sanitize` -- confirms XSS sanitization
4. Grep DocumentPreview.tsx for `dangerouslySetInnerHTML` -- confirms rendered output is used
  </verify>
  <done>DocumentPreview renders DOCX files as sanitized HTML in-browser. docx-preview is loaded via dynamic import (not in main bundle). DOMPurify sanitizes all rendered HTML before DOM insertion.</done>
</task>

</tasks>

<verification>
1. Frontend build succeeds: `cd /Users/mmaudet/work/validly/frontend && npm run build`
2. DocumentPreview.tsx contains dynamic import for docx-preview
3. DocumentPreview.tsx contains DOMPurify.sanitize call
4. No static import of docx-preview or dompurify at top of file (must be dynamic)
</verification>

<success_criteria>
- DOCX files with mimeType `application/vnd.openxmlformats-officedocument.wordprocessingml.document` render as HTML in DocumentPreview
- HTML output is sanitized through DOMPurify before DOM insertion
- docx-preview and dompurify are loaded via dynamic import(), not static import
- Existing PDF and image preview continue to work unchanged
- Frontend build passes
</success_criteria>

<output>
After completion, create `.planning/phases/13-foundation/13-02-SUMMARY.md`
</output>
